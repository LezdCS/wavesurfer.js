function e(e,t,i,s){return new(i||(i=Promise))((function(n,r){function o(e){try{l(s.next(e))}catch(e){r(e)}}function a(e){try{l(s.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}l((s=s.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class t{constructor(){this.listeners={}}on(e,t,i){if(this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t),null==i?void 0:i.once){const i=()=>{this.un(e,i),this.un(e,t)};return this.on(e,i),i}return()=>this.un(e,t)}un(e,t){var i;null===(i=this.listeners[e])||void 0===i||i.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((e=>e(...t)))}}class i extends t{constructor(e){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=e}onInit(){}_init(e){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((e=>e())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}function s(e,t){const i=t.xmlns?document.createElementNS(t.xmlns,e):document.createElement(e);for(const[e,n]of Object.entries(t))if("children"===e&&n)for(const[e,t]of Object.entries(n))t instanceof Node?i.appendChild(t):"string"==typeof t?i.appendChild(document.createTextNode(t)):i.appendChild(s(e,t));else"style"===e?Object.assign(i.style,n):"textContent"===e?i.textContent=n:i.setAttribute(e,n.toString());return i}function n(e,t,i){const n=s(e,t||{});return null==i||i.appendChild(n),n}let r;const o="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&o.decode();let a=null;function l(){return null!==a&&0!==a.byteLength||(a=new Uint8Array(r.memory.buffer)),a}function h(e,t){return e>>>=0,o.decode(l().subarray(e,e+t))}let c=0;const d="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},u="function"==typeof d.encodeInto?function(e,t){return d.encodeInto(e,t)}:function(e,t){const i=d.encode(e);return t.set(i),{read:e.length,written:i.length}};function f(e,t,i){if(void 0===i){const i=d.encode(e),s=t(i.length,1)>>>0;return l().subarray(s,s+i.length).set(i),c=i.length,s}let s=e.length,n=t(s,1)>>>0;const r=l();let o=0;for(;o<s;o++){const t=e.charCodeAt(o);if(t>127)break;r[n+o]=t}if(o!==s){0!==o&&(e=e.slice(o)),n=i(n,s,s=o+3*e.length,1)>>>0;const t=l().subarray(n+o,n+s);o+=u(e,t).written,n=i(n,s,o,1)>>>0}return c=o,n}let m=null;function p(){return(null===m||!0===m.buffer.detached||void 0===m.buffer.detached&&m.buffer!==r.memory.buffer)&&(m=new DataView(r.memory.buffer)),m}function g(e){const t=r.__wbindgen_export_3.get(e);return r.__externref_table_dealloc(e),t}let b=null;function w(){return null!==b&&0!==b.byteLength||(b=new Float32Array(r.memory.buffer)),b}function y(e,t){const i=t(4*e.length,4)>>>0;return w().set(e,i/4),c=e.length,i}function v(e,t){return e>>>=0,w().subarray(e/4,e/4+t)}function W(e,t,i){const s=y(e,r.__wbindgen_malloc),n=c,o=r.db_to_color_indices(s,n,t,i);var a,h,d=(a=o[0],h=o[1],a>>>=0,l().subarray(a/1,a/1+h)).slice();return r.__wbindgen_free(o[0],1*o[1],1),d}const T="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>r.__wbg_wasmfft_free(e>>>0,1)));class M{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,T.unregister(this),e}free(){const e=this.__destroy_into_raw();r.__wbg_wasmfft_free(e,0)}constructor(e,t,i){const s=f(t,r.__wbindgen_malloc,r.__wbindgen_realloc),n=c,o=r.wasmfft_new(e,s,n,null==i?4294967297:Math.fround(i));if(o[2])throw g(o[1]);return this.__wbg_ptr=o[0]>>>0,T.register(this,this.__wbg_ptr,this),this}calculate_spectrum(e){const t=y(e,r.__wbindgen_malloc),i=c,s=r.wasmfft_calculate_spectrum(this.__wbg_ptr,t,i);if(s[3])throw g(s[2]);var n=v(s[0],s[1]).slice();return r.__wbindgen_free(s[0],4*s[1],4),n}get size(){return r.wasmfft_size(this.__wbg_ptr)>>>0}}const L="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>r.__wbg_wasmfilterbank_free(e>>>0,1)));class x{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,L.unregister(this),e}free(){const e=this.__destroy_into_raw();r.__wbg_wasmfilterbank_free(e,0)}constructor(e,t,i,s){const n=f(s,r.__wbindgen_malloc,r.__wbindgen_realloc),o=c,a=r.wasmfilterbank_new(e,t,i,n,o);if(a[2])throw g(a[1]);return this.__wbg_ptr=a[0]>>>0,L.register(this,this.__wbg_ptr,this),this}apply(e){const t=y(e,r.__wbindgen_malloc),i=c,s=r.wasmfilterbank_apply(this.__wbg_ptr,t,i);if(s[3])throw g(s[2]);var n=v(s[0],s[1]).slice();return r.__wbindgen_free(s[0],4*s[1],4),n}}function S(){const e={wbg:{}};return e.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let i,s;try{i=e,s=t,console.error(h(e,t))}finally{r.__wbindgen_free(i,s,1)}},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const i=f(t.stack,r.__wbindgen_malloc,r.__wbindgen_realloc),s=c;p().setInt32(e+4,s,!0),p().setInt32(e+0,i,!0)},e.wbg.__wbindgen_init_externref_table=function(){const e=r.__wbindgen_export_3,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},e.wbg.__wbindgen_string_new=function(e,t){return h(e,t)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(h(e,t))},e}function F(e,t){return r=e.exports,_.__wbindgen_wasm_module=t,m=null,b=null,a=null,r.__wbindgen_start(),r}async function _(e){if(void 0!==r)return r;void 0!==e&&(Object.getPrototypeOf(e)===Object.prototype?({module_or_path:e}=e):console.warn("using deprecated parameters for the initialization function; pass a single object instead")),void 0===e&&(e=new URL("wavesurfer_fft_bg.wasm",import.meta.url));const t=S();("string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL)&&(e=fetch(e));const{instance:i,module:s}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const i=await e.arrayBuffer();return await WebAssembly.instantiate(i,t)}{const i=await WebAssembly.instantiate(e,t);return i instanceof WebAssembly.Instance?{instance:i,module:e}:i}}(await e,t);return F(i,s)}const P=1e3*Math.log(10)/107.939;function k(e){return 2595*Math.log10(1+e/700)}function G(e){return 700*(Math.pow(10,e/2595)-1)}function Z(e){return Math.log10(Math.max(1,e))}function X(e){return Math.pow(10,e)}function Y(e){let t=26.81*e/(1960+e)-.53;return t<2&&(t+=.15*(2-t)),t>20.1&&(t+=.22*(t-20.1)),t}function C(e){return e<2&&(e=(e-.3)/.85),e>20.1&&(e=(e+4.422)/1.22),(e+.53)/(26.28-e)*1960}function I(e){return P*Math.log10(1+.00437*e)}function K(e){return(Math.pow(10,e/P)-1)/.00437}function z(e,t){switch(t){case"mel":return k(e);case"logarithmic":return Z(e);case"bark":return Y(e);case"erb":return I(e);default:return e}}function V(e,t,i,s,n){const r=s(0),o=s(i/2),a=Array.from({length:e},(()=>Array(t/2+1).fill(0))),l=i/t;for(let t=0;t<e;t++){let i=n(r+t/e*(o-r)),s=Math.floor(i/l),h=s*l,c=(i-h)/((s+1)*l-h);a[t][s]=1-c,a[t][s+1]=c}return a}function R(e,t){const i=t.length,s=Float32Array.from({length:i},(()=>0));for(let n=0;n<i;n++)for(let i=0;i<e.length;i++)s[n]+=e[i]*t[n][i];return s}function E(e,t,i,s){switch(this.bufferSize=e,this.sampleRate=t,this.bandwidth=2/e*(t/2),this.sinTable=new Float32Array(e),this.cosTable=new Float32Array(e),this.windowValues=new Float32Array(e),this.reverseTable=new Uint32Array(e),this.peakBand=0,this.peak=0,i){case"bartlett":for(n=0;n<e;n++)this.windowValues[n]=2/(e-1)*((e-1)/2-Math.abs(n-(e-1)/2));break;case"bartlettHann":for(n=0;n<e;n++)this.windowValues[n]=.62-.48*Math.abs(n/(e-1)-.5)-.38*Math.cos(2*Math.PI*n/(e-1));break;case"blackman":for(s=s||.16,n=0;n<e;n++)this.windowValues[n]=(1-s)/2-.5*Math.cos(2*Math.PI*n/(e-1))+s/2*Math.cos(4*Math.PI*n/(e-1));break;case"cosine":for(n=0;n<e;n++)this.windowValues[n]=Math.cos(Math.PI*n/(e-1)-Math.PI/2);break;case"gauss":for(s=s||.25,n=0;n<e;n++)this.windowValues[n]=Math.pow(Math.E,-.5*Math.pow((n-(e-1)/2)/(s*(e-1)/2),2));break;case"hamming":for(n=0;n<e;n++)this.windowValues[n]=.54-.46*Math.cos(2*Math.PI*n/(e-1));break;case"hann":case void 0:for(n=0;n<e;n++)this.windowValues[n]=.5*(1-Math.cos(2*Math.PI*n/(e-1)));break;case"lanczoz":for(n=0;n<e;n++)this.windowValues[n]=Math.sin(Math.PI*(2*n/(e-1)-1))/(Math.PI*(2*n/(e-1)-1));break;case"rectangular":for(n=0;n<e;n++)this.windowValues[n]=1;break;case"triangular":for(n=0;n<e;n++)this.windowValues[n]=2/e*(e/2-Math.abs(n-(e-1)/2));break;default:throw Error("No such window function '"+i+"'")}for(var n,r=1,o=e>>1;r<e;){for(n=0;n<r;n++)this.reverseTable[n+r]=this.reverseTable[n]+o;r<<=1,o>>=1}for(n=0;n<e;n++)this.sinTable[n]=Math.sin(-Math.PI/n),this.cosTable[n]=Math.cos(-Math.PI/n);this.calculateSpectrum=function(e){var t,i,s,n=this.bufferSize,r=this.cosTable,o=this.sinTable,a=this.reverseTable,l=new Float32Array(n),h=new Float32Array(n),c=2/this.bufferSize,d=Math.sqrt,u=new Float32Array(n/2),f=Math.floor(Math.log(n)/Math.LN2);if(Math.pow(2,f)!==n)throw"Invalid buffer size, must be a power of 2.";if(n!==e.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+n+" Buffer Size: "+e.length;for(var m,p,g,b,w,y,v,W,T=1,M=0;M<n;M++)l[M]=e[a[M]]*this.windowValues[a[M]],h[M]=0;for(;T<n;){m=r[T],p=o[T],g=1,b=0;for(var L=0;L<T;L++){for(M=L;M<n;)y=g*l[w=M+T]-b*h[w],v=g*h[w]+b*l[w],l[w]=l[M]-y,h[w]=h[M]-v,l[M]+=y,h[M]+=v,M+=T<<1;g=(W=g)*m-b*p,b=W*p+b*m}T<<=1}M=0;for(var x=n/2;M<x;M++)(s=c*d((t=l[M])*t+(i=h[M])*i))>this.peak&&(this.peakBand=M,this.peak=s),u[M]=s;return u}}var j=null;try{var N="undefined"!=typeof module&&"function"==typeof module.require&&module.require("worker_threads")||"function"==typeof __non_webpack_require__&&__non_webpack_require__("worker_threads")||"function"==typeof require&&require("worker_threads");j=N.Worker}catch(e){}function A(e,t,i){var s=function(e){return Buffer.from(e,"base64").toString("utf8")}(e),n=s.indexOf("\n",10)+1,r=s.substring(n)+"";return function(e){return new j(r,Object.assign({},e,{eval:!0}))}}function U(e,t,i){var s=function(e){return atob(e)}(e),n=s.indexOf("\n",10)+1,r=s.substring(n)+"",o=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(o)}var B="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0);function O(e,t,i){return B?A(e):function(e){var t;return function(i){return t=t||U(e),new Worker(t,i)}}(e)}var J=O("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7Y2xhc3MgdHtjb25zdHJ1Y3Rvcih0LGUsYSxzKXtsZXQgcjtzd2l0Y2godGhpcy5idWZmZXJTaXplPXQsdGhpcy5zYW1wbGVSYXRlPWUsdGhpcy5iYW5kd2lkdGg9Mi90KihlLzIpLHRoaXMuc2luVGFibGU9bmV3IEZsb2F0MzJBcnJheSh0KSx0aGlzLmNvc1RhYmxlPW5ldyBGbG9hdDMyQXJyYXkodCksdGhpcy53aW5kb3dWYWx1ZXM9bmV3IEZsb2F0MzJBcnJheSh0KSx0aGlzLnJldmVyc2VUYWJsZT1uZXcgVWludDMyQXJyYXkodCksdGhpcy5wZWFrQmFuZD0wLHRoaXMucGVhaz0wLGEpe2Nhc2UiYmFydGxldHQiOmZvcihyPTA7cjx0O3IrKyl0aGlzLndpbmRvd1ZhbHVlc1tyXT0yLyh0LTEpKigodC0xKS8yLU1hdGguYWJzKHItKHQtMSkvMikpO2JyZWFrO2Nhc2UiYmFydGxldHRIYW5uIjpmb3Iocj0wO3I8dDtyKyspdGhpcy53aW5kb3dWYWx1ZXNbcl09LjYyLS40OCpNYXRoLmFicyhyLyh0LTEpLS41KS0uMzgqTWF0aC5jb3MoMipNYXRoLlBJKnIvKHQtMSkpO2JyZWFrO2Nhc2UiYmxhY2ttYW4iOmZvcihzPXN8fC4xNixyPTA7cjx0O3IrKyl0aGlzLndpbmRvd1ZhbHVlc1tyXT0oMS1zKS8yLS41Kk1hdGguY29zKDIqTWF0aC5QSSpyLyh0LTEpKStzLzIqTWF0aC5jb3MoNCpNYXRoLlBJKnIvKHQtMSkpO2JyZWFrO2Nhc2UiY29zaW5lIjpmb3Iocj0wO3I8dDtyKyspdGhpcy53aW5kb3dWYWx1ZXNbcl09TWF0aC5jb3MoTWF0aC5QSSpyLyh0LTEpLU1hdGguUEkvMik7YnJlYWs7Y2FzZSJnYXVzcyI6Zm9yKHM9c3x8LjI1LHI9MDtyPHQ7cisrKXRoaXMud2luZG93VmFsdWVzW3JdPU1hdGgucG93KE1hdGguRSwtLjUqTWF0aC5wb3coKHItKHQtMSkvMikvKHMqKHQtMSkvMiksMikpO2JyZWFrO2Nhc2UiaGFtbWluZyI6Zm9yKHI9MDtyPHQ7cisrKXRoaXMud2luZG93VmFsdWVzW3JdPS41NC0uNDYqTWF0aC5jb3MoMipNYXRoLlBJKnIvKHQtMSkpO2JyZWFrO2Nhc2UiaGFubiI6Y2FzZSB2b2lkIDA6Zm9yKHI9MDtyPHQ7cisrKXRoaXMud2luZG93VmFsdWVzW3JdPS41KigxLU1hdGguY29zKDIqTWF0aC5QSSpyLyh0LTEpKSk7YnJlYWs7Y2FzZSJsYW5jem96Ijpmb3Iocj0wO3I8dDtyKyspdGhpcy53aW5kb3dWYWx1ZXNbcl09TWF0aC5zaW4oTWF0aC5QSSooMipyLyh0LTEpLTEpKS8oTWF0aC5QSSooMipyLyh0LTEpLTEpKTticmVhaztjYXNlInJlY3Rhbmd1bGFyIjpmb3Iocj0wO3I8dDtyKyspdGhpcy53aW5kb3dWYWx1ZXNbcl09MTticmVhaztjYXNlInRyaWFuZ3VsYXIiOmZvcihyPTA7cjx0O3IrKyl0aGlzLndpbmRvd1ZhbHVlc1tyXT0yL3QqKHQvMi1NYXRoLmFicyhyLSh0LTEpLzIpKTticmVhaztkZWZhdWx0OnRocm93IEVycm9yKCJObyBzdWNoIHdpbmRvdyBmdW5jdGlvbiAnIithKyInIil9bGV0IG49MSxvPXQ+PjE7Zm9yKDtuPHQ7KXtmb3Iocj0wO3I8bjtyKyspdGhpcy5yZXZlcnNlVGFibGVbcituXT10aGlzLnJldmVyc2VUYWJsZVtyXStvO248PD0xLG8+Pj0xfWZvcihyPTA7cjx0O3IrKyl0aGlzLnNpblRhYmxlW3JdPU1hdGguc2luKC1NYXRoLlBJL3IpLHRoaXMuY29zVGFibGVbcl09TWF0aC5jb3MoLU1hdGguUEkvcil9Y2FsY3VsYXRlU3BlY3RydW0odCl7Y29uc3QgZT10aGlzLmJ1ZmZlclNpemUsYT10aGlzLmNvc1RhYmxlLHM9dGhpcy5zaW5UYWJsZSxyPXRoaXMucmV2ZXJzZVRhYmxlLG49bmV3IEZsb2F0MzJBcnJheShlKSxvPW5ldyBGbG9hdDMyQXJyYXkoZSksaT0yL3RoaXMuYnVmZmVyU2l6ZSxsPU1hdGguc3FydDtsZXQgaCxjLHU7Y29uc3QgZj1uZXcgRmxvYXQzMkFycmF5KGUvMiksdz1NYXRoLmZsb29yKE1hdGgubG9nKGUpL01hdGguTE4yKTtpZihNYXRoLnBvdygyLHcpIT09ZSl0aHJvdyJJbnZhbGlkIGJ1ZmZlciBzaXplLCBtdXN0IGJlIGEgcG93ZXIgb2YgMi4iO2lmKGUhPT10Lmxlbmd0aCl0aHJvdyJTdXBwbGllZCBidWZmZXIgaXMgbm90IHRoZSBzYW1lIHNpemUgYXMgZGVmaW5lZCBGRlQuIEZGVCBTaXplOiAiK2UrIiBCdWZmZXIgU2l6ZTogIit0Lmxlbmd0aDtsZXQgTSxiLGQscCxnLG0sayx5LFQ9MTtmb3IobGV0IGE9MDthPGU7YSsrKW5bYV09dFtyW2FdXSp0aGlzLndpbmRvd1ZhbHVlc1tyW2FdXSxvW2FdPTA7Zm9yKDtUPGU7KXtNPWFbVF0sYj1zW1RdLGQ9MSxwPTA7Zm9yKGxldCB0PTA7dDxUO3QrKyl7bGV0IGE9dDtmb3IoO2E8ZTspZz1hK1QsbT1kKm5bZ10tcCpvW2ddLGs9ZCpvW2ddK3AqbltnXSxuW2ddPW5bYV0tbSxvW2ddPW9bYV0tayxuW2FdKz1tLG9bYV0rPWssYSs9VDw8MTt5PWQsZD15Kk0tcCpiLHA9eSpiK3AqTX1UPDw9MX1mb3IobGV0IHQ9MCxhPWUvMjt0PGE7dCsrKWg9blt0XSxjPW9bdF0sdT1pKmwoaCpoK2MqYyksdT50aGlzLnBlYWsmJih0aGlzLnBlYWtCYW5kPXQsdGhpcy5wZWFrPXUpLGZbdF09dTtyZXR1cm4gZn19bGV0IGU9bnVsbDtjb25zdCBhPTFlMypNYXRoLmxvZygxMCkvMTA3LjkzOTtmdW5jdGlvbiBzKHQpe3JldHVybiAyNTk1Kk1hdGgubG9nMTAoMSt0LzcwMCl9ZnVuY3Rpb24gcih0KXtyZXR1cm4gNzAwKihNYXRoLnBvdygxMCx0LzI1OTUpLTEpfWZ1bmN0aW9uIG4odCl7cmV0dXJuIE1hdGgubG9nMTAoTWF0aC5tYXgoMSx0KSl9ZnVuY3Rpb24gbyh0KXtyZXR1cm4gTWF0aC5wb3coMTAsdCl9ZnVuY3Rpb24gaSh0KXtsZXQgZT0yNi44MSp0LygxOTYwK3QpLS41MztyZXR1cm4gZTwyJiYoZSs9LjE1KigyLWUpKSxlPjIwLjEmJihlKz0uMjIqKGUtMjAuMSkpLGV9ZnVuY3Rpb24gbCh0KXtyZXR1cm4gdDwyJiYodD0odC0uMykvLjg1KSx0PjIwLjEmJih0PSh0KzQuNDIyKS8xLjIyKSwodCsuNTMpLygyNi4yOC10KSoxOTYwfWZ1bmN0aW9uIGgodCl7cmV0dXJuIGEqTWF0aC5sb2cxMCgxKy4wMDQzNyp0KX1mdW5jdGlvbiBjKHQpe3JldHVybihNYXRoLnBvdygxMCx0L2EpLTEpLy4wMDQzN31mdW5jdGlvbiB1KHQsZSxhLHMscil7Y29uc3Qgbj1zKDApLG89cyhhLzIpLGk9QXJyYXkuZnJvbSh7bGVuZ3RoOnR9LCgoKT0+QXJyYXkoZS8yKzEpLmZpbGwoMCkpKSxsPWEvZTtmb3IobGV0IGU9MDtlPHQ7ZSsrKXtjb25zdCBhPXIobitlL3QqKG8tbikpLHM9TWF0aC5mbG9vcihhL2wpLGg9cypsLGM9KGEtaCkvKChzKzEpKmwtaCk7aVtlXVtzXT0xLWMsaVtlXVtzKzFdPWN9cmV0dXJuIGl9ZnVuY3Rpb24gZih0LGUpe2NvbnN0IGE9ZS5sZW5ndGgscz1uZXcgRmxvYXQzMkFycmF5KGEpO2ZvcihsZXQgcj0wO3I8YTtyKyspZm9yKGxldCBhPTA7YTx0Lmxlbmd0aDthKyspc1tyXSs9dFthXSplW3JdW2FdO3JldHVybiBzfXNlbGYub25tZXNzYWdlPWZ1bmN0aW9uKGEpe2NvbnN0e3R5cGU6dyxpZDpNLGF1ZGlvRGF0YTpiLG9wdGlvbnM6ZH09YS5kYXRhO2lmKCJjYWxjdWxhdGVGcmVxdWVuY2llcyI9PT13KXRyeXtjb25zdCBhPWZ1bmN0aW9uKGEsdyl7Y29uc3R7c3RhcnRUaW1lOk0sZW5kVGltZTpiLHNhbXBsZVJhdGU6ZCxmZnRTYW1wbGVzOnAsd2luZG93RnVuYzpnLGFscGhhOm0sbm92ZXJsYXA6ayxzY2FsZTp5LGdhaW5EQjpULHJhbmdlREI6RixzcGxpdENoYW5uZWxzOkl9PXcsVj1NYXRoLmZsb29yKE0qZCksQT1NYXRoLmZsb29yKGIqZCksUD1JP2EubGVuZ3RoOjE7ZSYmZS5idWZmZXJTaXplPT09cHx8KGU9bmV3IHQocCxkLGcsbSkpO2xldCBTPW51bGw7Y29uc3Qgej1wLzI7c3dpdGNoKHkpe2Nhc2UibWVsIjpTPXUoeixwLGQscyxyKTticmVhaztjYXNlImxvZ2FyaXRobWljIjpTPXUoeixwLGQsbixvKTticmVhaztjYXNlImJhcmsiOlM9dSh6LHAsZCxpLGwpO2JyZWFrO2Nhc2UiZXJiIjpTPXUoeixwLGQsaCxjKTticmVhaztkZWZhdWx0OlM9bnVsbH1sZXQgdj1rfHxNYXRoLm1heCgwLE1hdGgucm91bmQoLjUqcCkpO2NvbnN0IEI9LjUqcDt2PU1hdGgubWluKHYsQik7Y29uc3QgcT1NYXRoLm1heCg2NCwuMjUqcCkseD1NYXRoLm1heChxLHAtdiksUj1bXTtmb3IobGV0IHQ9MDt0PFA7dCsrKXtjb25zdCBzPWFbdF0scj1bXTtmb3IobGV0IHQ9Vjt0K3A8QTt0Kz14KXtjb25zdCBhPXMuc2xpY2UodCx0K3ApO2xldCBuPWUuY2FsY3VsYXRlU3BlY3RydW0oYSk7UyYmKG49ZihuLFMpKTtjb25zdCBvPW5ldyBVaW50OEFycmF5KG4ubGVuZ3RoKSxpPVQrRjtmb3IobGV0IHQ9MDt0PG4ubGVuZ3RoO3QrKyl7Y29uc3QgZT1uW3RdPjFlLTEyP25bdF06MWUtMTIsYT0yMCpNYXRoLmxvZzEwKGUpO29bdF09YTwtaT8wOmE+LVQ/MjU1Ok1hdGgucm91bmQoKGErVCkvRioyNTUpfXIucHVzaChvKX1SLnB1c2gocil9cmV0dXJuIFJ9KGIsZCksdz17dHlwZToiZnJlcXVlbmNpZXNSZXN1bHQiLGlkOk0scmVzdWx0OmF9O3NlbGYucG9zdE1lc3NhZ2Uodyl9Y2F0Y2godCl7Y29uc3QgZT17dHlwZToiZnJlcXVlbmNpZXNSZXN1bHQiLGlkOk0sZXJyb3I6dCBpbnN0YW5jZW9mIEVycm9yP3QubWVzc2FnZTpTdHJpbmcodCl9O3NlbGYucG9zdE1lc3NhZ2UoZSl9fX0oKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9c3BlY3Ryb2dyYW0td29ya2VyLmpzLm1hcAoK");class Q extends i{static create(e){return new Q(e||{})}constructor(e){var t,i;super(e),this.segments=new Map,this.buffer=null,this.currentPosition=0,this.pixelsPerSecond=0,this.isRendering=!1,this.renderTimeout=null,this.fft=null,this.wasmFFT=null,this.wasmFilterBank=null,this.isWasmAvailable=!1,this.progressiveLoadTimeout=null,this.isProgressiveLoading=!1,this.nextProgressiveSegmentTime=0,this.worker=null,this.workerPromises=new Map,this.qualityUpdateTimeout=null,this._onWrapperClick=e=>{const t=this.wrapper.getBoundingClientRect(),i=(e.clientX-t.left)/t.width;this.emit("click",i)},this.container="string"==typeof e.container?document.querySelector(e.container):e.container,this.setupColorMap(e.colorMap),this.fftSamples=e.fftSamples||512,this.height=e.height||200,this.noverlap=e.noverlap||null,this.windowFunc=e.windowFunc||"hann",this.alpha=e.alpha,this.frequencyMin=e.frequencyMin||0,this.frequencyMax=e.frequencyMax||0,this.gainDB=null!==(t=e.gainDB)&&void 0!==t?t:20,this.rangeDB=null!==(i=e.rangeDB)&&void 0!==i?i:80,this.scale=e.scale||"mel",this.windowSize=e.windowSize||30,this.bufferSize=e.bufferSize||5e3,this.progressiveLoading=!0===e.progressiveLoading,this.useWebWorker=!0===e.useWebWorker&&"undefined"!=typeof window,this.numMelFilters=this.fftSamples/2,this.numLogFilters=this.fftSamples/2,this.numBarkFilters=this.fftSamples/2,this.numErbFilters=this.fftSamples/2,this.createWrapper(),this.createCanvas(),this.useWebWorker&&this.initializeWorker()}initializeWorker(){if("undefined"!=typeof window&&"undefined"!=typeof Worker)try{this.worker=new J,this.worker.onmessage=e=>{const{type:t,id:i,result:s,error:n}=e.data;if("frequenciesResult"===t){const e=this.workerPromises.get(i);e&&(this.workerPromises.delete(i),n?e.reject(new Error(n)):e.resolve(s))}},this.worker.onerror=e=>{console.warn("Spectrogram worker error, falling back to main thread:",e),this.worker=null}}catch(e){console.warn("Failed to initialize worker, falling back to main thread:",e),this.worker=null}else console.warn("Worker not available in this environment, using main thread calculation")}setupColorMap(e){if(e&&"string"!=typeof e){if(e.length<256)throw new Error("Colormap must contain 256 elements");this.colorMap=e}else{const t=e||"roseus";switch(t){case"gray":this.colorMap=[];for(let e=0;e<256;e++){const t=(255-e)/256;this.colorMap.push([t,t,t,1])}break;case"igray":this.colorMap=[];for(let e=0;e<256;e++){const t=e/256;this.colorMap.push([t,t,t,1])}break;case"roseus":this.colorMap=[[.004528,.004341,.004307,1],[.005625,.006156,.00601,1],[.006628,.008293,.008161,1],[.007551,.010738,.01079,1],[.008382,.013482,.013941,1],[.009111,.01652,.017662,1],[.009727,.019846,.022009,1],[.010223,.023452,.027035,1],[.010593,.027331,.032799,1],[.010833,.031475,.039361,1],[.010941,.035875,.046415,1],[.010918,.04052,.053597,1],[.010768,.045158,.060914,1],[.010492,.049708,.068367,1],[.010098,.054171,.075954,1],[.009594,.058549,.083672,1],[.008989,.06284,.091521,1],[.008297,.067046,.099499,1],[.00753,.071165,.107603,1],[.006704,.075196,.11583,1],[.005838,.07914,.124178,1],[.004949,.082994,.132643,1],[.004062,.086758,.141223,1],[.003198,.09043,.149913,1],[.002382,.09401,.158711,1],[.001643,.097494,.167612,1],[.001009,.100883,.176612,1],[514e-6,.104174,.185704,1],[187e-6,.107366,.194886,1],[66e-6,.110457,.204151,1],[186e-6,.113445,.213496,1],[587e-6,.116329,.222914,1],[.001309,.119106,.232397,1],[.002394,.121776,.241942,1],[.003886,.124336,.251542,1],[.005831,.126784,.261189,1],[.008276,.12912,.270876,1],[.011268,.131342,.280598,1],[.014859,.133447,.290345,1],[.0191,.135435,.300111,1],[.024043,.137305,.309888,1],[.029742,.139054,.319669,1],[.036252,.140683,.329441,1],[.043507,.142189,.339203,1],[.050922,.143571,.348942,1],[.058432,.144831,.358649,1],[.066041,.145965,.368319,1],[.073744,.146974,.377938,1],[.081541,.147858,.387501,1],[.089431,.148616,.396998,1],[.097411,.149248,.406419,1],[.105479,.149754,.415755,1],[.113634,.150134,.424998,1],[.121873,.150389,.434139,1],[.130192,.150521,.443167,1],[.138591,.150528,.452075,1],[.147065,.150413,.460852,1],[.155614,.150175,.469493,1],[.164232,.149818,.477985,1],[.172917,.149343,.486322,1],[.181666,.148751,.494494,1],[.190476,.148046,.502493,1],[.199344,.147229,.510313,1],[.208267,.146302,.517944,1],[.217242,.145267,.52538,1],[.226264,.144131,.532613,1],[.235331,.142894,.539635,1],[.24444,.141559,.546442,1],[.253587,.140131,.553026,1],[.262769,.138615,.559381,1],[.271981,.137016,.5655,1],[.281222,.135335,.571381,1],[.290487,.133581,.577017,1],[.299774,.131757,.582404,1],[.30908,.129867,.587538,1],[.318399,.12792,.592415,1],[.32773,.125921,.597032,1],[.337069,.123877,.601385,1],[.346413,.121793,.605474,1],[.355758,.119678,.609295,1],[.365102,.11754,.612846,1],[.374443,.115386,.616127,1],[.383774,.113226,.619138,1],[.393096,.111066,.621876,1],[.402404,.108918,.624343,1],[.411694,.106794,.62654,1],[.420967,.104698,.628466,1],[.430217,.102645,.630123,1],[.439442,.100647,.631513,1],[.448637,.098717,.632638,1],[.457805,.096861,.633499,1],[.46694,.095095,.6341,1],[.47604,.093433,.634443,1],[.485102,.091885,.634532,1],[.494125,.090466,.63437,1],[.503104,.08919,.633962,1],[.512041,.088067,.633311,1],[.520931,.087108,.63242,1],[.529773,.086329,.631297,1],[.538564,.085738,.629944,1],[.547302,.085346,.628367,1],[.555986,.085162,.626572,1],[.564615,.08519,.624563,1],[.573187,.085439,.622345,1],[.581698,.085913,.619926,1],[.590149,.086615,.617311,1],[.598538,.087543,.614503,1],[.606862,.0887,.611511,1],[.61512,.090084,.608343,1],[.623312,.09169,.605001,1],[.631438,.093511,.601489,1],[.639492,.095546,.597821,1],[.647476,.097787,.593999,1],[.655389,.100226,.590028,1],[.66323,.102856,.585914,1],[.670995,.105669,.581667,1],[.678686,.108658,.577291,1],[.686302,.111813,.57279,1],[.69384,.115129,.568175,1],[.7013,.118597,.563449,1],[.708682,.122209,.558616,1],[.715984,.125959,.553687,1],[.723206,.12984,.548666,1],[.730346,.133846,.543558,1],[.737406,.13797,.538366,1],[.744382,.142209,.533101,1],[.751274,.146556,.527767,1],[.758082,.151008,.522369,1],[.764805,.155559,.516912,1],[.771443,.160206,.511402,1],[.777995,.164946,.505845,1],[.784459,.169774,.500246,1],[.790836,.174689,.494607,1],[.797125,.179688,.488935,1],[.803325,.184767,.483238,1],[.809435,.189925,.477518,1],[.815455,.19516,.471781,1],[.821384,.200471,.466028,1],[.827222,.205854,.460267,1],[.832968,.211308,.454505,1],[.838621,.216834,.448738,1],[.844181,.222428,.442979,1],[.849647,.22809,.43723,1],[.855019,.233819,.431491,1],[.860295,.239613,.425771,1],[.865475,.245471,.420074,1],[.870558,.251393,.414403,1],[.875545,.25738,.408759,1],[.880433,.263427,.403152,1],[.885223,.269535,.397585,1],[.889913,.275705,.392058,1],[.894503,.281934,.386578,1],[.898993,.288222,.381152,1],[.903381,.294569,.375781,1],[.907667,.300974,.370469,1],[.911849,.307435,.365223,1],[.915928,.313953,.360048,1],[.919902,.320527,.354948,1],[.923771,.327155,.349928,1],[.927533,.333838,.344994,1],[.931188,.340576,.340149,1],[.934736,.347366,.335403,1],[.938175,.354207,.330762,1],[.941504,.361101,.326229,1],[.944723,.368045,.321814,1],[.947831,.375039,.317523,1],[.950826,.382083,.313364,1],[.953709,.389175,.309345,1],[.956478,.396314,.305477,1],[.959133,.403499,.301766,1],[.961671,.410731,.298221,1],[.964093,.418008,.294853,1],[.966399,.425327,.291676,1],[.968586,.43269,.288696,1],[.970654,.440095,.285926,1],[.972603,.44754,.28338,1],[.974431,.455025,.281067,1],[.976139,.462547,.279003,1],[.977725,.470107,.277198,1],[.979188,.477703,.275666,1],[.980529,.485332,.274422,1],[.981747,.492995,.273476,1],[.98284,.50069,.272842,1],[.983808,.508415,.272532,1],[.984653,.516168,.27256,1],[.985373,.523948,.272937,1],[.985966,.531754,.273673,1],[.986436,.539582,.274779,1],[.98678,.547434,.276264,1],[.986998,.555305,.278135,1],[.987091,.563195,.280401,1],[.987061,.5711,.283066,1],[.986907,.579019,.286137,1],[.986629,.58695,.289615,1],[.986229,.594891,.293503,1],[.985709,.602839,.297802,1],[.985069,.610792,.302512,1],[.98431,.618748,.307632,1],[.983435,.626704,.313159,1],[.982445,.634657,.319089,1],[.981341,.642606,.32542,1],[.98013,.650546,.332144,1],[.978812,.658475,.339257,1],[.977392,.666391,.346753,1],[.97587,.67429,.354625,1],[.974252,.68217,.362865,1],[.972545,.690026,.371466,1],[.97075,.697856,.380419,1],[.968873,.705658,.389718,1],[.966921,.713426,.399353,1],[.964901,.721157,.409313,1],[.962815,.728851,.419594,1],[.960677,.7365,.430181,1],[.95849,.744103,.44107,1],[.956263,.751656,.452248,1],[.954009,.759153,.463702,1],[.951732,.766595,.475429,1],[.949445,.773974,.487414,1],[.947158,.781289,.499647,1],[.944885,.788535,.512116,1],[.942634,.795709,.524811,1],[.940423,.802807,.537717,1],[.938261,.809825,.550825,1],[.936163,.81676,.564121,1],[.934146,.823608,.577591,1],[.932224,.830366,.59122,1],[.930412,.837031,.604997,1],[.928727,.843599,.618904,1],[.927187,.850066,.632926,1],[.925809,.856432,.647047,1],[.92461,.862691,.661249,1],[.923607,.868843,.675517,1],[.92282,.874884,.689832,1],[.922265,.880812,.704174,1],[.921962,.886626,.718523,1],[.92193,.892323,.732859,1],[.922183,.897903,.747163,1],[.922741,.903364,.76141,1],[.92362,.908706,.77558,1],[.924837,.913928,.789648,1],[.926405,.919031,.80359,1],[.92834,.924015,.817381,1],[.930655,.928881,.830995,1],[.93336,.933631,.844405,1],[.936466,.938267,.857583,1],[.939982,.942791,.870499,1],[.943914,.947207,.883122,1],[.948267,.951519,.895421,1],[.953044,.955732,.907359,1],[.958246,.959852,.918901,1],[.963869,.963887,.930004,1],[.969909,.967845,.940623,1],[.976355,.971737,.950704,1],[.983195,.97558,.960181,1],[.990402,.979395,.968966,1],[.99793,.983217,.97692,1]];break;default:throw Error("No such colormap '"+t+"'")}}}onInit(){this.wrapper||this.createWrapper(),this.canvasContainer||this.createCanvas();try{try{const e=function(e){if(void 0!==r)return r;void 0!==e&&(Object.getPrototypeOf(e)===Object.prototype?({module:e}=e):console.warn("using deprecated parameters for `initSync()`; pass a single object instead"));const t=S();return e instanceof WebAssembly.Module||(e=new WebAssembly.Module(e)),F(new WebAssembly.Instance(e,t),e)}();console.log("✅ WASM module initialized synchronously:",e),this.isWasmAvailable=!0}catch(e){console.log("⚠️ Sync init failed, trying async init..."),_().then((e=>{console.log("✅ WASM module initialized asynchronously:",e),this.isWasmAvailable=!0})).catch((e=>{console.warn("❌ Async WASM init failed:",e.message),console.log("Will use JavaScript fallback for FFT calculations"),this.isWasmAvailable=!1}))}}catch(e){console.warn("❌ WASM FFT not available, using JavaScript fallback:",e.message),this.isWasmAvailable=!1}this.container=this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&Object.assign(this.wrapper.style,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("timeupdate",(e=>{this.updatePosition(e)}))),this.subscriptions.push(this.wavesurfer.on("scroll",(()=>{this.handleScroll()}))),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.handleRedraw()))),this.subscriptions.push(this.wavesurfer.on("ready",(()=>{const e=this.wavesurfer.getDecodedData();e&&this.render(e)}))),this.wavesurfer.getDecodedData()&&setTimeout((()=>{this.render(this.wavesurfer.getDecodedData())}),0)}createWrapper(){this.wrapper=n("div",{style:{display:"block",position:"relative",userSelect:"none"}}),this.options.labels&&(this.labelsEl=n("canvas",{part:"spec-labels",style:{position:"absolute",zIndex:9,width:"55px",height:"100%"}},this.wrapper)),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvasContainer=n("div",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}},this.wrapper)}handleRedraw(){const e=this.pixelsPerSecond;this.pixelsPerSecond=this.getPixelsPerSecond(),e!==this.pixelsPerSecond&&this.segments.size>0&&this.updateSegmentPositions(e,this.pixelsPerSecond),this.scheduleRender()}updateSegmentPositions(e,t){for(const e of this.segments.values())if(e.startPixel=e.startTime*t,e.endPixel=e.endTime*t,e.canvas){const t=e.endPixel-e.startPixel;e.canvas.style.left=`${e.startPixel}px`,e.canvas.style.width=`${t}px`}const i=t/e;(i<.5||i>2)&&this.scheduleSegmentQualityUpdate()}scheduleSegmentQualityUpdate(){this.qualityUpdateTimeout&&clearTimeout(this.qualityUpdateTimeout),this.qualityUpdateTimeout=window.setTimeout((()=>{this.updateVisibleSegmentQuality()}),500)}updateVisibleSegmentQuality(){return e(this,void 0,void 0,(function*(){var e;if(!this.buffer)return;const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper();if(!t)return;const i=this.getScrollLeft(t),s=this.getViewportWidth(t),n=this.getPixelsPerSecond(),r=i/n,o=(i+s)/n,a=Array.from(this.segments.values()).filter((e=>e.startTime<o&&e.endTime>r));if(0!==a.length)for(const e of a)e.canvas&&(yield this.renderSegment(e))}))}getScrollLeft(e){var t;if(e.scrollLeft)return e.scrollLeft;if(null===(t=e.parentElement)||void 0===t?void 0:t.scrollLeft)return e.parentElement.scrollLeft;if(document.documentElement.scrollLeft)return document.documentElement.scrollLeft;if(document.body.scrollLeft)return document.body.scrollLeft;if(window.scrollX)return window.scrollX;if(window.pageXOffset)return window.pageXOffset;let i=e.parentElement;for(;i;){const e=window.getComputedStyle(i);if(("scroll"===e.overflowX||"auto"===e.overflowX)&&i.scrollLeft>0)return i.scrollLeft;i=i.parentElement}return 0}getViewportWidth(e){var t,i;const s=e.offsetWidth||e.clientWidth,n=(null===(t=e.parentElement)||void 0===t?void 0:t.offsetWidth)||(null===(i=e.parentElement)||void 0===i?void 0:i.clientWidth),r=window.innerWidth;return n&&n<s?n:Math.min(s||800,.8*r)}handleScroll(){var e,t;const i=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper();let s=0;if(null==i?void 0:i.scrollLeft)s=i.scrollLeft;else if(null===(t=null==i?void 0:i.parentElement)||void 0===t?void 0:t.scrollLeft)s=i.parentElement.scrollLeft;else if(document.documentElement.scrollLeft||document.body.scrollLeft)s=document.documentElement.scrollLeft||document.body.scrollLeft;else if(window.scrollX||window.pageXOffset)s=window.scrollX||window.pageXOffset;else if(i){let e=i.parentElement;for(;e&&0===s;){const t=window.getComputedStyle(e);if(("scroll"===t.overflowX||"auto"===t.overflowX)&&e.scrollLeft>0){s=e.scrollLeft;break}e=e.parentElement}}this.getPixelsPerSecond(),this.scheduleRender()}updatePosition(e){this.currentPosition=e,this.scheduleRender()}scheduleRender(){this.renderTimeout&&clearTimeout(this.renderTimeout),this.renderTimeout=window.setTimeout((()=>{this.renderVisibleWindow()}),16)}renderVisibleWindow(){return e(this,void 0,void 0,(function*(){var e;if(!this.isRendering&&this.buffer){this.isRendering=!0;try{const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper();if(!t)return;const i=this.getScrollLeft(t),s=this.getViewportWidth(t),n=this.getPixelsPerSecond(),r=(this.buffer.duration,i/n),o=(i+s)/n,a=o-r;let l=Math.min(2,.5*a);a>30&&(console.warn(`⚠️ Large visible duration: ${a.toFixed(1)}s - limiting buffer`),l=1);const h=Math.max(0,r-l),c=Math.min(this.buffer.duration,o+l);yield this.generateSegments(h,c)}finally{this.isRendering=!1}}}))}generateSegments(t,i){return e(this,void 0,void 0,(function*(){if(!this.buffer)return;const e=this.getPixelsPerSecond(),s=this.getWidth(),n=this.buffer.duration,r=this.isProgressiveLoading&&i-t<=35,o=!r&&n*e<=s&&n<=60;let a,l;if(r?(l=i-t,a=l*e,console.log(`🔧 Progressive loading mode: duration=${l.toFixed(1)}s, pixels=${a.toFixed(0)}px`)):o?(a=s,l=n,console.log(`🔧 Fill container mode: duration=${l.toFixed(1)}s, pixels=${a.toFixed(0)}px`)):(a=15e3,l=a/e,console.log(`🔧 Viewport rendering mode: duration=${l.toFixed(1)}s, pixels=${a.toFixed(0)}px`)),this.segments.size>0)for(const[e,t]of this.segments);const h=this.findUncoveredTimeRanges(t,i,l);if(0!==h.length){for(const t of h)for(let i=t.start;i<t.end;i+=l){const n=i,r=Math.min(i+l,t.end,this.buffer.duration),a=`${Math.floor(10*n)}_${Math.floor(10*r)}`;if(this.segments.has(a))continue;performance.now();const h=yield this.calculateFrequencies(n,r);if(performance.now(),h&&h.length>0){const t={startTime:n,endTime:r,startPixel:o?0:n*e,endPixel:o?s:r*e,frequencies:h};this.segments.set(a,t),performance.now(),yield this.renderSegment(t),performance.now(),this.emitProgress()}}this.isProgressiveLoading||this.startProgressiveLoading()}}))}findUncoveredTimeRanges(e,t,i){const s=Array.from(this.segments.values()).sort(((e,t)=>e.startTime-t.startTime)),n=[];let r=e;for(const e of s){if(r<e.startTime&&r<t){const i=Math.min(e.startTime,t);n.push({start:r,end:i})}if(r=Math.max(r,e.endTime),r>=t)break}return r<t&&n.push({start:r,end:t}),n}startProgressiveLoading(){!this.isProgressiveLoading&&this.buffer&&this.progressiveLoading&&(this.isProgressiveLoading=!0,this.nextProgressiveSegmentTime=0,this.progressiveLoadTimeout=window.setTimeout((()=>{this.progressiveLoadNextSegment()}),1e3))}progressiveLoadNextSegment(){return e(this,void 0,void 0,(function*(){if(!this.buffer||!this.isProgressiveLoading)return;const e=this.buffer.duration;if(this.nextProgressiveSegmentTime>=e)return void this._stopProgressiveLoading();const t=this.nextProgressiveSegmentTime,i=Math.min(t+30,e);console.log(`📊 Progressive segment calculation: start=${t.toFixed(2)}s, end=${i.toFixed(2)}s, duration=${30..toFixed(2)}s`);const s=`${Math.floor(10*t)}_${Math.floor(10*i)}`;if(this.segments.has(s))console.log(`⏭️ Progressive segment already loaded: ${t.toFixed(1)}s - ${i.toFixed(1)}s`);else try{console.log(`🔄 Progressive loading segment: ${t.toFixed(1)}s - ${i.toFixed(1)}s`),yield this.generateSegments(t,i),console.log(`✅ Progressive loaded segment: ${t.toFixed(1)}s - ${i.toFixed(1)}s`)}catch(e){return console.warn("Progressive loading failed:",e),void this._stopProgressiveLoading()}this.nextProgressiveSegmentTime=i,this.progressiveLoadTimeout=window.setTimeout((()=>{this.progressiveLoadNextSegment()}),2e3)}))}_stopProgressiveLoading(){this.isProgressiveLoading=!1,this.progressiveLoadTimeout&&(clearTimeout(this.progressiveLoadTimeout),this.progressiveLoadTimeout=null)}getLoadingProgress(){if(!this.buffer)return 0;const e=this.buffer.duration;if(0===e)return 100;if(!this.isProgressiveLoading&&0===this.segments.size)return 0;const t=Math.min(100,this.nextProgressiveSegmentTime/e*100);return!this.isProgressiveLoading&&this.nextProgressiveSegmentTime>=e?100:t}isUsingWasm(){return this.isWasmAvailable&&null!==this.wasmFFT}getFFTInfo(){return this.isWasmAvailable&&this.wasmFFT?{type:"WASM",available:!0}:this.fft?{type:"JavaScript",available:!0}:{type:"JavaScript",available:!1}}emitProgress(){const e=this.getLoadingProgress()/100;this.emit("progress",e)}calculateFrequencies(t,i){return e(this,void 0,void 0,(function*(){if(!this.buffer)return[];const e=performance.now();if(this.buffer.sampleRate,!this.options.splitChannels||this.buffer.numberOfChannels,this.worker&&!this.isWasmAvailable)try{const e=yield this.calculateFrequenciesWithWorker(t,i);performance.now();return e}catch(e){console.warn("Worker calculation failed, falling back to main thread:",e)}return this.calculateFrequenciesMainThread(t,i)}))}calculateFrequenciesWithWorker(t,i){return e(this,void 0,void 0,(function*(){if(!this.buffer||!this.worker)throw new Error("Worker not available");const e=this.buffer.sampleRate,s=this.options.splitChannels?this.buffer.numberOfChannels:1;let n=this.noverlap;if(!n){const s=(i-t)*this.getPixelsPerSecond(),r=Math.floor(t*e),o=(Math.floor(i*e)-r)/s;n=Math.max(0,Math.round(this.fftSamples-o))}const r=[];for(let e=0;e<s;e++)r.push(this.buffer.getChannelData(e));const o=`${Date.now()}_${Math.random()}`,a=new Promise(((e,t)=>{this.workerPromises.set(o,{resolve:e,reject:t}),setTimeout((()=>{this.workerPromises.has(o)&&(this.workerPromises.delete(o),t(new Error("Worker timeout")))}),3e4)}));return this.worker.postMessage({type:"calculateFrequencies",id:o,audioData:r,options:{startTime:t,endTime:i,sampleRate:e,fftSamples:this.fftSamples,windowFunc:this.windowFunc,alpha:this.alpha,noverlap:n,scale:this.scale,gainDB:this.gainDB,rangeDB:this.rangeDB,splitChannels:this.options.splitChannels||!1,useWasm:this.isWasmAvailable}}),a}))}calculateFrequenciesMainThread(t,i){return e(this,void 0,void 0,(function*(){if(!this.buffer)return[];const e=this.buffer.sampleRate,s=Math.floor(t*e),n=Math.floor(i*e),r=this.options.splitChannels?this.buffer.numberOfChannels:1;if(this.isWasmAvailable&&!this.wasmFFT)try{this.wasmFFT=new M(this.fftSamples,this.windowFunc||"hann",this.alpha),"linear"!==this.scale&&(this.wasmFilterBank=new x(this.fftSamples/2,this.fftSamples,e,this.scale)),console.log("✅ WASM FFT and FilterBank initialized for calculations")}catch(e){console.warn("⚠️ Failed to create WASM FFT/FilterBank, falling back to JS:",e),this.isWasmAvailable=!1}this.isWasmAvailable||this.fft||(this.fft=new E(this.fftSamples,e,this.windowFunc,this.alpha));let o=this.noverlap;if(!o){const e=(n-s)/((i-t)*this.getPixelsPerSecond());o=Math.max(0,Math.round(this.fftSamples-e))}const a=.5*this.fftSamples;o=Math.min(o,a);const l=Math.max(64,.25*this.fftSamples),h=Math.max(l,this.fftSamples-o),c=[],d=performance.now();let u=0;for(let t=0;t<r;t++){const i=this.buffer.getChannelData(t),r=[];for(let t=s;t+this.fftSamples<n;t+=h){const s=i.slice(t,t+this.fftSamples);let n,o;if(this.isWasmAvailable&&this.wasmFFT)n=this.wasmFFT.calculate_spectrum(s),this.wasmFilterBank&&(n=this.wasmFilterBank.apply(n));else{if(!this.fft)return console.error("No FFT available!"),[];{n=this.fft.calculateSpectrum(s);const t=this.getFilterBank(e);t&&(n=R(n,t))}}if(u++,this.isWasmAvailable&&this.wasmFFT)try{o=W(n,this.gainDB||20,this.rangeDB||80)}catch(e){console.warn("WASM color conversion failed, using JS fallback:",e),o=this.convertSpectrumToColors(n)}else o=this.convertSpectrumToColors(n);r.push(o)}c.push(r)}const f=performance.now(),m=this.isWasmAvailable?"WASM":"JS";return console.log(`🔧 ${m} FFT calculation: ${u} FFTs in ${(f-d).toFixed(1)}ms`),c}))}convertSpectrumToColors(e){const t=new Uint8Array(e.length),i=this.gainDB+this.rangeDB;for(let s=0;s<e.length;s++){const n=e[s]>1e-12?e[s]:1e-12,r=20*Math.log10(n);r<-i?t[s]=0:r>-this.gainDB?t[s]=255:t[s]=Math.round((r+this.gainDB)/this.rangeDB*255)}return t}renderSegment(t){return e(this,void 0,void 0,(function*(){var e;const i=t.endPixel-t.startPixel,s=this.height*t.frequencies.length,n=document.createElement("canvas");n.width=Math.round(i),n.height=Math.round(s),n.style.position="absolute",n.style.left=`${t.startPixel}px`,n.style.top="0",n.style.width=`${i}px`,n.style.height=`${s}px`;const r=n.getContext("2d");if(!r)return;const o=(null===(e=this.buffer)||void 0===e?void 0:e.sampleRate)?this.buffer.sampleRate/2:0,a=this.frequencyMin,l=this.frequencyMax||o;for(let e=0;e<t.frequencies.length;e++)yield this.renderChannelToCanvas(t.frequencies[e],r,i,this.height,e*this.height,o,a,l);t.canvas=n,this.canvasContainer.appendChild(n)}))}renderChannelToCanvas(t,i,s,n,r,o,a,l){return e(this,void 0,void 0,(function*(){if(0===t.length)return;const e=t[0].length,h=new ImageData(t.length,e),c=h.data;for(let i=0;i<t.length;i++){const s=t[i];for(let n=0;n<e;n++){const r=Math.min(255,Math.max(0,s[n])),o=this.colorMap[r],a=4*((e-n-1)*t.length+i);c[a]=255*o[0],c[a+1]=255*o[1],c[a+2]=255*o[2],c[a+3]=255*o[3]}}const d=z(a,this.scale)/z(o,this.scale),u=z(l,this.scale)/z(o,this.scale),f=Math.min(1,u),m=n*f/u,p=r+n*(1-f/u),g=Math.round(e*(1-f)),b=Math.round(e*(f-d)),w=yield createImageBitmap(h,0,g,t.length,b);i.drawImage(w,0,p,s,m),"close"in w&&w.close()}))}clearAllSegments(){for(const e of this.segments.values())e.canvas&&e.canvas.remove();this.segments.clear()}getFilterBank(e){switch(this.scale){case"mel":return V(this.numMelFilters,this.fftSamples,e,k,G);case"logarithmic":return V(this.numLogFilters,this.fftSamples,e,Z,X);case"bark":return V(this.numBarkFilters,this.fftSamples,e,Y,C);case"erb":return V(this.numErbFilters,this.fftSamples,e,I,K);default:return null}}freqType(e){return e>=1e3?(e/1e3).toFixed(1):Math.round(e)}unitType(e){return e>=1e3?"kHz":"Hz"}getLabelFrequency(e,t){const i=z(this.frequencyMin,this.scale);return function(e,t){switch(t){case"mel":return G(e);case"logarithmic":return X(e);case"bark":return C(e);case"erb":return K(e);default:return e}}(i+e/t*(z(this.frequencyMax,this.scale)-i),this.scale)}loadLabels(e,t,i,s,n,r,o,a,l){e=e||"rgba(68,68,68,0)",t=t||"12px",i=i||"12px",s=s||"Helvetica",n=n||"#fff",r=r||"#fff",o=o||"center";const h=this.height||512,c=h/256*5;this.frequencyMin;const d=this.labelsEl.getContext("2d"),u=window.devicePixelRatio;if(this.labelsEl.height=this.height*l*u,this.labelsEl.width=55*u,d.scale(u,u),d)for(let a=0;a<l;a++){let l;for(d.fillStyle=e,d.fillRect(0,a*h,55,(1+a)*h),d.fill(),l=0;l<=c;l++){d.textAlign=o,d.textBaseline="middle";const e=this.getLabelFrequency(l,c),u=this.freqType(e),f=this.unitType(e),m=16;let p=(1+a)*h-l/c*h;p=Math.min(Math.max(p,a*h+10),(1+a)*h-10),d.fillStyle=r,d.font=i+" "+s,d.fillText(f,m+24,p),d.fillStyle=n,d.font=t+" "+s,d.fillText(u.toString(),m,p)}}}render(t){return e(this,void 0,void 0,(function*(){this.buffer=t,this.pixelsPerSecond=this.getPixelsPerSecond(),this.frequencyMax=this.frequencyMax||t.sampleRate/2;const e=this.options.splitChannels?t.numberOfChannels:1;this.wrapper.style.height=this.height*e+"px",this.clearAllSegments(),this.nextProgressiveSegmentTime=0,this.options.labels&&this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",e),this.scheduleRender(),this.emit("ready")}))}destroy(){this.unAll(),this.renderTimeout&&(clearTimeout(this.renderTimeout),this.renderTimeout=null),this.qualityUpdateTimeout&&(clearTimeout(this.qualityUpdateTimeout),this.qualityUpdateTimeout=null),this.stopProgressiveLoading(),this.nextProgressiveSegmentTime=0,this.worker&&(this.worker.terminate(),this.worker=null);for(const[e,t]of this.workerPromises)t.reject(new Error("Plugin destroyed"));if(this.workerPromises.clear(),this.clearAllSegments(),this.wasmFFT){try{this.wasmFFT.free(),console.log("🧹 WASM FFT memory cleaned up")}catch(e){console.warn("Failed to clean up WASM FFT:",e)}this.wasmFFT=null}if(this.wasmFilterBank){try{this.wasmFilterBank.free(),console.log("🧹 WASM FilterBank memory cleaned up")}catch(e){console.warn("Failed to clean up WASM FilterBank:",e)}this.wasmFilterBank=null}this.canvasContainer&&(this.canvasContainer.remove(),this.canvasContainer=null),this.wrapper&&(this.wrapper.remove(),this.wrapper=null),this.labelsEl&&(this.labelsEl.remove(),this.labelsEl=null),this.container=null,this.buffer=null,this.fft=null,this.wasmFFT=null,this.wasmFilterBank=null,this.isWasmAvailable=!1,this.isRendering=!1,this.currentPosition=0,this.pixelsPerSecond=0,super.destroy()}getWidth(){var e,t;return(null===(t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper())||void 0===t?void 0:t.offsetWidth)||0}getPixelsPerSecond(){var e;const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.options.minPxPerSec;if(t&&t>0)return t;if(this.buffer){const e=this.getWidth(),t=e>0?e/this.buffer.duration:100;return Math.max(t,50)}return 50}stopProgressiveLoading(){this.isProgressiveLoading=!1,this.progressiveLoadTimeout&&(clearTimeout(this.progressiveLoadTimeout),this.progressiveLoadTimeout=null)}restartProgressiveLoading(){this.stopProgressiveLoading(),this.nextProgressiveSegmentTime=0,this.progressiveLoading&&this.startProgressiveLoading()}}export{Q as default};
