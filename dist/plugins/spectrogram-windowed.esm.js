function e(e,t,s,i){return new(s||(s=Promise))((function(o,r){function n(e){try{a(i.next(e))}catch(e){r(e)}}function l(e){try{a(i.throw(e))}catch(e){r(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,l)}a((i=i.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class t{constructor(){this.listeners={}}on(e,t,s){if(this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t),null==s?void 0:s.once){const s=()=>{this.un(e,s),this.un(e,t)};return this.on(e,s),s}return()=>this.un(e,t)}un(e,t){var s;null===(s=this.listeners[e])||void 0===s||s.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((e=>e(...t)))}}class s extends t{constructor(e){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=e}onInit(){}_init(e){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((e=>e())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}function i(e,t){const s=t.xmlns?document.createElementNS(t.xmlns,e):document.createElement(e);for(const[e,o]of Object.entries(t))if("children"===e&&o)for(const[e,t]of Object.entries(o))t instanceof Node?s.appendChild(t):"string"==typeof t?s.appendChild(document.createTextNode(t)):s.appendChild(i(e,t));else"style"===e?Object.assign(s.style,o):"textContent"===e?s.textContent=o:s.setAttribute(e,o.toString());return s}function o(e,t,s){const o=i(e,t||{});return null==s||s.appendChild(o),o}const r=1e3*Math.log(10)/107.939;function n(e,t,s,i){switch(this.bufferSize=e,this.sampleRate=t,this.bandwidth=2/e*(t/2),this.sinTable=new Float32Array(e),this.cosTable=new Float32Array(e),this.windowValues=new Float32Array(e),this.reverseTable=new Uint32Array(e),this.peakBand=0,this.peak=0,s){case"bartlett":for(o=0;o<e;o++)this.windowValues[o]=2/(e-1)*((e-1)/2-Math.abs(o-(e-1)/2));break;case"bartlettHann":for(o=0;o<e;o++)this.windowValues[o]=.62-.48*Math.abs(o/(e-1)-.5)-.38*Math.cos(2*Math.PI*o/(e-1));break;case"blackman":for(i=i||.16,o=0;o<e;o++)this.windowValues[o]=(1-i)/2-.5*Math.cos(2*Math.PI*o/(e-1))+i/2*Math.cos(4*Math.PI*o/(e-1));break;case"cosine":for(o=0;o<e;o++)this.windowValues[o]=Math.cos(Math.PI*o/(e-1)-Math.PI/2);break;case"gauss":for(i=i||.25,o=0;o<e;o++)this.windowValues[o]=Math.pow(Math.E,-.5*Math.pow((o-(e-1)/2)/(i*(e-1)/2),2));break;case"hamming":for(o=0;o<e;o++)this.windowValues[o]=.54-.46*Math.cos(2*Math.PI*o/(e-1));break;case"hann":case void 0:for(o=0;o<e;o++)this.windowValues[o]=.5*(1-Math.cos(2*Math.PI*o/(e-1)));break;case"lanczoz":for(o=0;o<e;o++)this.windowValues[o]=Math.sin(Math.PI*(2*o/(e-1)-1))/(Math.PI*(2*o/(e-1)-1));break;case"rectangular":for(o=0;o<e;o++)this.windowValues[o]=1;break;case"triangular":for(o=0;o<e;o++)this.windowValues[o]=2/e*(e/2-Math.abs(o-(e-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var o,r=1,n=e>>1;r<e;){for(o=0;o<r;o++)this.reverseTable[o+r]=this.reverseTable[o]+n;r<<=1,n>>=1}for(o=0;o<e;o++)this.sinTable[o]=Math.sin(-Math.PI/o),this.cosTable[o]=Math.cos(-Math.PI/o);this.calculateSpectrum=function(e){var t,s,i,o=this.bufferSize,r=this.cosTable,n=this.sinTable,l=this.reverseTable,a=new Float32Array(o),h=new Float32Array(o),c=2/this.bufferSize,d=Math.sqrt,u=new Float32Array(o/2),f=Math.floor(Math.log(o)/Math.LN2);if(Math.pow(2,f)!==o)throw"Invalid buffer size, must be a power of 2.";if(o!==e.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+o+" Buffer Size: "+e.length;for(var g,p,m,w,v,b,x,T,y=1,M=0;M<o;M++)a[M]=e[l[M]]*this.windowValues[l[M]],h[M]=0;for(;y<o;){g=r[y],p=n[y],m=1,w=0;for(var S=0;S<y;S++){for(M=S;M<o;)b=m*a[v=M+y]-w*h[v],x=m*h[v]+w*a[v],a[v]=a[M]-b,h[v]=h[M]-x,a[M]+=b,h[M]+=x,M+=y<<1;m=(T=m)*g-w*p,w=T*p+w*g}y<<=1}M=0;for(var P=o/2;M<P;M++)(i=c*d((t=a[M])*t+(s=h[M])*s))>this.peak&&(this.peakBand=M,this.peak=i),u[M]=i;return u}}class l extends s{static create(e){return new l(e||{})}constructor(e){var t,s;super(e),this.segments=new Map,this.buffer=null,this.currentPosition=0,this.pixelsPerSecond=0,this.isRendering=!1,this.renderTimeout=null,this.fft=null,this.progressiveLoadTimeout=null,this.isProgressiveLoading=!1,this.worker=null,this.workerPromises=new Map,this.qualityUpdateTimeout=null,this._onWrapperClick=e=>{const t=this.wrapper.getBoundingClientRect(),s=(e.clientX-t.left)/t.width;this.emit("click",s)},this.container="string"==typeof e.container?document.querySelector(e.container):e.container,this.setupColorMap(e.colorMap),this.fftSamples=e.fftSamples||512,this.height=e.height||200,this.noverlap=e.noverlap||null,this.windowFunc=e.windowFunc||"hann",this.alpha=e.alpha,this.frequencyMin=e.frequencyMin||0,this.frequencyMax=e.frequencyMax||0,this.gainDB=null!==(t=e.gainDB)&&void 0!==t?t:20,this.rangeDB=null!==(s=e.rangeDB)&&void 0!==s?s:80,this.scale=e.scale||"mel",this.windowSize=e.windowSize||30,this.bufferSize=e.bufferSize||5e3,this.progressiveLoading=!0===e.progressiveLoading,this.useWebWorker=!1!==e.useWebWorker,this.numMelFilters=this.fftSamples/2,this.numLogFilters=this.fftSamples/2,this.numBarkFilters=this.fftSamples/2,this.numErbFilters=this.fftSamples/2,this.createWrapper(),this.createCanvas(),this.useWebWorker&&this.initializeWorker()}initializeWorker(){try{this.worker=new Worker(new URL("./spectrogram-windowed.worker.js",import.meta.url)),this.worker.onmessage=e=>{const{type:t,id:s,result:i,error:o}=e.data;if("frequenciesResult"===t){const e=this.workerPromises.get(s);e&&(this.workerPromises.delete(s),o?e.reject(new Error(o)):e.resolve(i))}},this.worker.onerror=e=>{console.error("Spectrogram worker error:",e),this.worker=null},console.log("🔧 Spectrogram worker initialized from external file")}catch(e){console.warn("Failed to initialize worker, falling back to main thread:",e),this.worker=null}}setupColorMap(e){if(e&&"string"!=typeof e){if(e.length<256)throw new Error("Colormap must contain 256 elements");this.colorMap=e}else{const t=e||"roseus";switch(t){case"gray":this.colorMap=[];for(let e=0;e<256;e++){const t=(255-e)/256;this.colorMap.push([t,t,t,1])}break;case"igray":this.colorMap=[];for(let e=0;e<256;e++){const t=e/256;this.colorMap.push([t,t,t,1])}break;case"roseus":this.colorMap=[[.004528,.004341,.004307,1],[.005625,.006156,.00601,1],[.006628,.008293,.008161,1],[.007551,.010738,.01079,1],[.008382,.013482,.013941,1],[.009111,.01652,.017662,1],[.009727,.019846,.022009,1],[.010223,.023452,.027035,1],[.010593,.027331,.032799,1],[.010833,.031475,.039361,1],[.010941,.035875,.046415,1],[.010918,.04052,.053597,1],[.010768,.045158,.060914,1],[.010492,.049708,.068367,1],[.010098,.054171,.075954,1],[.009594,.058549,.083672,1],[.008989,.06284,.091521,1],[.008297,.067046,.099499,1],[.00753,.071165,.107603,1],[.006704,.075196,.11583,1],[.005838,.07914,.124178,1],[.004949,.082994,.132643,1],[.004062,.086758,.141223,1],[.003198,.09043,.149913,1],[.002382,.09401,.158711,1],[.001643,.097494,.167612,1],[.001009,.100883,.176612,1],[514e-6,.104174,.185704,1],[187e-6,.107366,.194886,1],[66e-6,.110457,.204151,1],[186e-6,.113445,.213496,1],[587e-6,.116329,.222914,1],[.001309,.119106,.232397,1],[.002394,.121776,.241942,1],[.003886,.124336,.251542,1],[.005831,.126784,.261189,1],[.008276,.12912,.270876,1],[.011268,.131342,.280598,1],[.014859,.133447,.290345,1],[.0191,.135435,.300111,1],[.024043,.137305,.309888,1],[.029742,.139054,.319669,1],[.036252,.140683,.329441,1],[.043507,.142189,.339203,1],[.050922,.143571,.348942,1],[.058432,.144831,.358649,1],[.066041,.145965,.368319,1],[.073744,.146974,.377938,1],[.081541,.147858,.387501,1],[.089431,.148616,.396998,1],[.097411,.149248,.406419,1],[.105479,.149754,.415755,1],[.113634,.150134,.424998,1],[.121873,.150389,.434139,1],[.130192,.150521,.443167,1],[.138591,.150528,.452075,1],[.147065,.150413,.460852,1],[.155614,.150175,.469493,1],[.164232,.149818,.477985,1],[.172917,.149343,.486322,1],[.181666,.148751,.494494,1],[.190476,.148046,.502493,1],[.199344,.147229,.510313,1],[.208267,.146302,.517944,1],[.217242,.145267,.52538,1],[.226264,.144131,.532613,1],[.235331,.142894,.539635,1],[.24444,.141559,.546442,1],[.253587,.140131,.553026,1],[.262769,.138615,.559381,1],[.271981,.137016,.5655,1],[.281222,.135335,.571381,1],[.290487,.133581,.577017,1],[.299774,.131757,.582404,1],[.30908,.129867,.587538,1],[.318399,.12792,.592415,1],[.32773,.125921,.597032,1],[.337069,.123877,.601385,1],[.346413,.121793,.605474,1],[.355758,.119678,.609295,1],[.365102,.11754,.612846,1],[.374443,.115386,.616127,1],[.383774,.113226,.619138,1],[.393096,.111066,.621876,1],[.402404,.108918,.624343,1],[.411694,.106794,.62654,1],[.420967,.104698,.628466,1],[.430217,.102645,.630123,1],[.439442,.100647,.631513,1],[.448637,.098717,.632638,1],[.457805,.096861,.633499,1],[.46694,.095095,.6341,1],[.47604,.093433,.634443,1],[.485102,.091885,.634532,1],[.494125,.090466,.63437,1],[.503104,.08919,.633962,1],[.512041,.088067,.633311,1],[.520931,.087108,.63242,1],[.529773,.086329,.631297,1],[.538564,.085738,.629944,1],[.547302,.085346,.628367,1],[.555986,.085162,.626572,1],[.564615,.08519,.624563,1],[.573187,.085439,.622345,1],[.581698,.085913,.619926,1],[.590149,.086615,.617311,1],[.598538,.087543,.614503,1],[.606862,.0887,.611511,1],[.61512,.090084,.608343,1],[.623312,.09169,.605001,1],[.631438,.093511,.601489,1],[.639492,.095546,.597821,1],[.647476,.097787,.593999,1],[.655389,.100226,.590028,1],[.66323,.102856,.585914,1],[.670995,.105669,.581667,1],[.678686,.108658,.577291,1],[.686302,.111813,.57279,1],[.69384,.115129,.568175,1],[.7013,.118597,.563449,1],[.708682,.122209,.558616,1],[.715984,.125959,.553687,1],[.723206,.12984,.548666,1],[.730346,.133846,.543558,1],[.737406,.13797,.538366,1],[.744382,.142209,.533101,1],[.751274,.146556,.527767,1],[.758082,.151008,.522369,1],[.764805,.155559,.516912,1],[.771443,.160206,.511402,1],[.777995,.164946,.505845,1],[.784459,.169774,.500246,1],[.790836,.174689,.494607,1],[.797125,.179688,.488935,1],[.803325,.184767,.483238,1],[.809435,.189925,.477518,1],[.815455,.19516,.471781,1],[.821384,.200471,.466028,1],[.827222,.205854,.460267,1],[.832968,.211308,.454505,1],[.838621,.216834,.448738,1],[.844181,.222428,.442979,1],[.849647,.22809,.43723,1],[.855019,.233819,.431491,1],[.860295,.239613,.425771,1],[.865475,.245471,.420074,1],[.870558,.251393,.414403,1],[.875545,.25738,.408759,1],[.880433,.263427,.403152,1],[.885223,.269535,.397585,1],[.889913,.275705,.392058,1],[.894503,.281934,.386578,1],[.898993,.288222,.381152,1],[.903381,.294569,.375781,1],[.907667,.300974,.370469,1],[.911849,.307435,.365223,1],[.915928,.313953,.360048,1],[.919902,.320527,.354948,1],[.923771,.327155,.349928,1],[.927533,.333838,.344994,1],[.931188,.340576,.340149,1],[.934736,.347366,.335403,1],[.938175,.354207,.330762,1],[.941504,.361101,.326229,1],[.944723,.368045,.321814,1],[.947831,.375039,.317523,1],[.950826,.382083,.313364,1],[.953709,.389175,.309345,1],[.956478,.396314,.305477,1],[.959133,.403499,.301766,1],[.961671,.410731,.298221,1],[.964093,.418008,.294853,1],[.966399,.425327,.291676,1],[.968586,.43269,.288696,1],[.970654,.440095,.285926,1],[.972603,.44754,.28338,1],[.974431,.455025,.281067,1],[.976139,.462547,.279003,1],[.977725,.470107,.277198,1],[.979188,.477703,.275666,1],[.980529,.485332,.274422,1],[.981747,.492995,.273476,1],[.98284,.50069,.272842,1],[.983808,.508415,.272532,1],[.984653,.516168,.27256,1],[.985373,.523948,.272937,1],[.985966,.531754,.273673,1],[.986436,.539582,.274779,1],[.98678,.547434,.276264,1],[.986998,.555305,.278135,1],[.987091,.563195,.280401,1],[.987061,.5711,.283066,1],[.986907,.579019,.286137,1],[.986629,.58695,.289615,1],[.986229,.594891,.293503,1],[.985709,.602839,.297802,1],[.985069,.610792,.302512,1],[.98431,.618748,.307632,1],[.983435,.626704,.313159,1],[.982445,.634657,.319089,1],[.981341,.642606,.32542,1],[.98013,.650546,.332144,1],[.978812,.658475,.339257,1],[.977392,.666391,.346753,1],[.97587,.67429,.354625,1],[.974252,.68217,.362865,1],[.972545,.690026,.371466,1],[.97075,.697856,.380419,1],[.968873,.705658,.389718,1],[.966921,.713426,.399353,1],[.964901,.721157,.409313,1],[.962815,.728851,.419594,1],[.960677,.7365,.430181,1],[.95849,.744103,.44107,1],[.956263,.751656,.452248,1],[.954009,.759153,.463702,1],[.951732,.766595,.475429,1],[.949445,.773974,.487414,1],[.947158,.781289,.499647,1],[.944885,.788535,.512116,1],[.942634,.795709,.524811,1],[.940423,.802807,.537717,1],[.938261,.809825,.550825,1],[.936163,.81676,.564121,1],[.934146,.823608,.577591,1],[.932224,.830366,.59122,1],[.930412,.837031,.604997,1],[.928727,.843599,.618904,1],[.927187,.850066,.632926,1],[.925809,.856432,.647047,1],[.92461,.862691,.661249,1],[.923607,.868843,.675517,1],[.92282,.874884,.689832,1],[.922265,.880812,.704174,1],[.921962,.886626,.718523,1],[.92193,.892323,.732859,1],[.922183,.897903,.747163,1],[.922741,.903364,.76141,1],[.92362,.908706,.77558,1],[.924837,.913928,.789648,1],[.926405,.919031,.80359,1],[.92834,.924015,.817381,1],[.930655,.928881,.830995,1],[.93336,.933631,.844405,1],[.936466,.938267,.857583,1],[.939982,.942791,.870499,1],[.943914,.947207,.883122,1],[.948267,.951519,.895421,1],[.953044,.955732,.907359,1],[.958246,.959852,.918901,1],[.963869,.963887,.930004,1],[.969909,.967845,.940623,1],[.976355,.971737,.950704,1],[.983195,.97558,.960181,1],[.990402,.979395,.968966,1],[.99793,.983217,.97692,1]];break;default:throw Error("No such colormap '"+t+"'")}}}onInit(){this.wrapper||this.createWrapper(),this.canvasContainer||this.createCanvas(),this.container=this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&Object.assign(this.wrapper.style,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("timeupdate",(e=>{this.updatePosition(e)}))),this.subscriptions.push(this.wavesurfer.on("scroll",(()=>{this.handleScroll()}))),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.handleRedraw()))),this.subscriptions.push(this.wavesurfer.on("ready",(()=>{const e=this.wavesurfer.getDecodedData();e&&this.render(e)}))),this.wavesurfer.getDecodedData()&&setTimeout((()=>{this.render(this.wavesurfer.getDecodedData())}),0)}createWrapper(){this.wrapper=o("div",{style:{display:"block",position:"relative",userSelect:"none"}}),this.options.labels&&(this.labelsEl=o("canvas",{part:"spec-labels",style:{position:"absolute",zIndex:9,width:"55px",height:"100%"}},this.wrapper)),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvasContainer=o("div",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}},this.wrapper)}handleRedraw(){const e=this.pixelsPerSecond;this.pixelsPerSecond=this.getPixelsPerSecond(),e!==this.pixelsPerSecond&&this.segments.size>0&&(console.log(`🔄 Zoom changed: ${e.toFixed(1)} → ${this.pixelsPerSecond.toFixed(1)} px/s`),this.updateSegmentPositions(e,this.pixelsPerSecond)),this.scheduleRender()}updateSegmentPositions(e,t){console.log(`📐 Updating ${this.segments.size} segment positions without recalculating frequencies`);for(const e of this.segments.values())if(e.startPixel=e.startTime*t,e.endPixel=e.endTime*t,e.canvas){const t=e.endPixel-e.startPixel;e.canvas.style.left=`${e.startPixel}px`,e.canvas.style.width=`${t}px`}const s=t/e;(s<.5||s>2)&&(console.log(`📐 Significant zoom change (${s.toFixed(2)}x), will re-render visible segments`),this.scheduleSegmentQualityUpdate())}scheduleSegmentQualityUpdate(){this.qualityUpdateTimeout&&clearTimeout(this.qualityUpdateTimeout),this.qualityUpdateTimeout=window.setTimeout((()=>{this.updateVisibleSegmentQuality()}),500)}updateVisibleSegmentQuality(){return e(this,void 0,void 0,(function*(){var e;if(!this.buffer)return;const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper();if(!t)return;const s=this.getScrollLeft(t),i=this.getViewportWidth(t),o=this.getPixelsPerSecond(),r=s/o,n=(s+i)/o;console.log(`🔧 Updating quality for visible segments: ${r.toFixed(1)}s - ${n.toFixed(1)}s`);const l=Array.from(this.segments.values()).filter((e=>e.startTime<n&&e.endTime>r));if(0!==l.length){console.log(`  - Found ${l.length} visible segments to update`);for(const e of l)e.canvas&&(console.log(`  - Re-rendering segment ${e.startTime.toFixed(1)}s - ${e.endTime.toFixed(1)}s`),yield this.renderSegment(e));console.log(`✅ Quality update complete for ${l.length} segments`)}else console.log("  - No visible segments to update")}))}getScrollLeft(e){var t;if(e.scrollLeft)return e.scrollLeft;if(null===(t=e.parentElement)||void 0===t?void 0:t.scrollLeft)return e.parentElement.scrollLeft;if(document.documentElement.scrollLeft)return document.documentElement.scrollLeft;if(document.body.scrollLeft)return document.body.scrollLeft;if(window.scrollX)return window.scrollX;if(window.pageXOffset)return window.pageXOffset;let s=e.parentElement;for(;s;){const e=window.getComputedStyle(s);if(("scroll"===e.overflowX||"auto"===e.overflowX)&&s.scrollLeft>0)return s.scrollLeft;s=s.parentElement}return 0}getViewportWidth(e){var t,s;const i=e.offsetWidth||e.clientWidth,o=(null===(t=e.parentElement)||void 0===t?void 0:t.offsetWidth)||(null===(s=e.parentElement)||void 0===s?void 0:s.clientWidth),r=window.innerWidth;return o&&o<i?o:Math.min(i||800,.8*r)}handleScroll(){var e,t;const s=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper();let i=0;if(null==s?void 0:s.scrollLeft)i=s.scrollLeft;else if(null===(t=null==s?void 0:s.parentElement)||void 0===t?void 0:t.scrollLeft)i=s.parentElement.scrollLeft;else if(document.documentElement.scrollLeft||document.body.scrollLeft)i=document.documentElement.scrollLeft||document.body.scrollLeft;else if(window.scrollX||window.pageXOffset)i=window.scrollX||window.pageXOffset;else if(s){let e=s.parentElement;for(;e&&0===i;){const t=window.getComputedStyle(e);if(("scroll"===t.overflowX||"auto"===t.overflowX)&&e.scrollLeft>0){i=e.scrollLeft;break}e=e.parentElement}}const o=this.getPixelsPerSecond(),r=i/o;console.log("🌊 Scroll event detected:"),console.log(`  - Scroll position: ${i}px`),console.log(`  - Current view time: ${r.toFixed(1)}s`),console.log(`  - Pixels per second: ${o}`),console.log("  - Scheduling render..."),this.scheduleRender()}updatePosition(e){this.currentPosition=e,this.scheduleRender()}scheduleRender(){this.renderTimeout&&clearTimeout(this.renderTimeout),this.renderTimeout=window.setTimeout((()=>{this.renderVisibleWindow()}),16)}renderVisibleWindow(){return e(this,void 0,void 0,(function*(){var e;if(!this.isRendering&&this.buffer){this.isRendering=!0;try{const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper();if(!t)return;const s=this.getScrollLeft(t),i=this.getViewportWidth(t),o=this.getPixelsPerSecond(),r=this.buffer.duration;console.log("📊 Debug windowed render:"),console.log(`  - Scroll left: ${s}px`),console.log(`  - Viewport width: ${i}px`),console.log(`  - Pixels per second: ${o}`),console.log(`  - Total audio duration: ${r.toFixed(1)}s`);const n=s/o,l=(s+i)/o;console.log(`  - Visible time range: ${n.toFixed(1)}s - ${l.toFixed(1)}s`),console.log(`  - Visible duration: ${(l-n).toFixed(1)}s`);const a=l-n;let h=Math.min(2,.5*a);a>30&&(console.warn(`⚠️ Large visible duration: ${a.toFixed(1)}s - limiting buffer`),h=1);const c=Math.max(0,n-h),d=Math.min(this.buffer.duration,l+h);console.log(`🎯 Render window: ${c.toFixed(1)}s - ${d.toFixed(1)}s (${(d-c).toFixed(1)}s total, buffer: ${h.toFixed(1)}s)`),yield this.generateSegments(c,d)}finally{this.isRendering=!1}}}))}generateSegments(t,s){return e(this,void 0,void 0,(function*(){if(!this.buffer)return;const e=this.getPixelsPerSecond(),i=this.getWidth(),o=this.buffer.duration,r=o*e<=i&&o<=60;let n,l;if(r?(n=i,l=o,console.log(`🎯 Short audio mode: filling container width ${i}px with ${o.toFixed(1)}s audio`)):(n=15e3,l=n/e,console.log(`🌊 Windowed mode: ${n}px segments = ${l.toFixed(1)}s per segment`)),console.log(`🔧 Generating segments for ${t.toFixed(1)}s - ${s.toFixed(1)}s`),console.log(`   - Segment size: ${n}px = ${l.toFixed(1)}s per segment`),console.log(`   - Current segments count: ${this.segments.size}`),this.segments.size>0){console.log("   - Existing segments:");for(const[e,t]of this.segments)console.log(`     * ${e}: ${t.startTime.toFixed(1)}s - ${t.endTime.toFixed(1)}s`)}const a=this.findUncoveredTimeRanges(t,s,l);if(0===a.length)return void console.log(`   - ✅ Time range ${t.toFixed(1)}s - ${s.toFixed(1)}s is already fully covered`);console.log(`   - Found ${a.length} uncovered ranges:`);for(const e of a)console.log(`     * ${e.start.toFixed(1)}s - ${e.end.toFixed(1)}s`);let h=0;for(const t of a)for(let s=t.start;s<t.end;s+=l){const o=s,n=Math.min(s+l,t.end,this.buffer.duration),a=`${Math.floor(10*o)}_${Math.floor(10*n)}`;if(this.segments.has(a)){console.log(`   - Segment ${a} unexpectedly exists, skipping`);continue}console.log(`   - Creating new segment: ${a} (${o.toFixed(1)}s - ${n.toFixed(1)}s, ${l.toFixed(1)}s duration)`),h++;const c=performance.now(),d=yield this.calculateFrequencies(o,n),u=performance.now();if(console.log(`   - ⏱️ FFT calculation took: ${(u-c).toFixed(1)}ms`),d&&d.length>0){const t={startTime:o,endTime:n,startPixel:r?0:o*e,endPixel:r?i:n*e,frequencies:d};this.segments.set(a,t);const s=performance.now();yield this.renderSegment(t);const l=performance.now();console.log(`   - ⏱️ Canvas rendering took: ${(l-s).toFixed(1)}ms`),console.log(`   - ✅ Segment ${a} rendered successfully (Total: ${(l-c).toFixed(1)}ms)`),this.emitProgress()}else console.log(`   - ❌ Failed to generate frequencies for segment ${a}`)}console.log(`🔧 Segment generation complete: ${h} new segments created, ${this.segments.size} total`),console.log("   - Final segments:");for(const[e,t]of this.segments)console.log(`     * ${e}: ${t.startTime.toFixed(1)}s - ${t.endTime.toFixed(1)}s`);this.isProgressiveLoading||this.startProgressiveLoading()}))}findUncoveredTimeRanges(e,t,s){const i=Array.from(this.segments.values()).sort(((e,t)=>e.startTime-t.startTime)),o=[];let r=e;for(const e of i){if(r<e.startTime&&r<t){const s=Math.min(e.startTime,t);o.push({start:r,end:s})}if(r=Math.max(r,e.endTime),r>=t)break}return r<t&&o.push({start:r,end:t}),o}startProgressiveLoading(){!this.isProgressiveLoading&&this.buffer&&this.progressiveLoading&&(this.isProgressiveLoading=!0,console.log("🔄 Starting progressive background loading..."),this.progressiveLoadTimeout=window.setTimeout((()=>{this.progressiveLoadNextSegment()}),1e3))}progressiveLoadNextSegment(){return e(this,void 0,void 0,(function*(){if(!this.buffer||!this.isProgressiveLoading)return;const e=15e3/this.getPixelsPerSecond(),t=this.buffer.duration;let s=0;const i=[];for(const e of this.segments.values())i.push({start:e.startTime,end:e.endTime});i.sort(((e,t)=>e.start-t.start));for(let o=0;o<t;o+=e){const r=Math.min(o+e,t);if(!i.some((e=>o>=e.start&&r<=e.end))){s=o;break}}if(s<t){const i=Math.min(s+e,t);console.log(`🔄 Progressive loading: ${s.toFixed(1)}s - ${i.toFixed(1)}s`);try{yield this.generateSegments(s,i),this.progressiveLoadTimeout=window.setTimeout((()=>{this.progressiveLoadNextSegment()}),5e3)}catch(e){console.error("Progressive loading error:",e),this._stopProgressiveLoading()}}else console.log(`✅ Progressive loading complete! All ${this.segments.size} segments loaded.`),this._stopProgressiveLoading()}))}_stopProgressiveLoading(){this.isProgressiveLoading=!1,this.progressiveLoadTimeout&&(clearTimeout(this.progressiveLoadTimeout),this.progressiveLoadTimeout=null)}getLoadingProgress(){if(!this.buffer)return 0;const e=this.buffer.duration,t=15e3/this.getPixelsPerSecond(),s=Math.ceil(e/t);if(0===s)return 100;const i=this.segments.size;return Math.min(100,i/s*100)}emitProgress(){const e=this.getLoadingProgress()/100;this.emit("progress",e)}calculateFrequencies(t,s){return e(this,void 0,void 0,(function*(){if(!this.buffer)return[];const e=performance.now();if(this.buffer.sampleRate,!this.options.splitChannels||this.buffer.numberOfChannels,this.worker)try{console.log("     - 🔧 Using web worker for FFT calculations");const i=yield this.calculateFrequenciesWithWorker(t,s),o=performance.now()-e;return console.log(`     - ⏱️ Worker calculation completed in: ${o.toFixed(1)}ms`),i}catch(e){console.warn("Worker calculation failed, falling back to main thread:",e)}return console.log("     - 🔧 Using main thread for FFT calculations"),this.calculateFrequenciesMainThread(t,s)}))}calculateFrequenciesWithWorker(t,s){return e(this,void 0,void 0,(function*(){if(!this.buffer||!this.worker)throw new Error("Worker not available");const e=this.buffer.sampleRate,i=this.options.splitChannels?this.buffer.numberOfChannels:1;let o=this.noverlap;if(!o){const i=(s-t)*this.getPixelsPerSecond(),r=Math.floor(t*e),n=(Math.floor(s*e)-r)/i;o=Math.max(0,Math.round(this.fftSamples-n))}const r=[];for(let e=0;e<i;e++)r.push(this.buffer.getChannelData(e));const n=`${Date.now()}_${Math.random()}`,l=new Promise(((e,t)=>{this.workerPromises.set(n,{resolve:e,reject:t}),setTimeout((()=>{this.workerPromises.has(n)&&(this.workerPromises.delete(n),t(new Error("Worker timeout")))}),3e4)}));return this.worker.postMessage({type:"calculateFrequencies",id:n,audioData:r,options:{startTime:t,endTime:s,sampleRate:e,fftSamples:this.fftSamples,windowFunc:this.windowFunc,alpha:this.alpha,noverlap:o,scale:this.scale,gainDB:this.gainDB,rangeDB:this.rangeDB,splitChannels:this.options.splitChannels||!1}}),l}))}calculateFrequenciesMainThread(t,s){return e(this,void 0,void 0,(function*(){if(!this.buffer)return[];const e=this.buffer.sampleRate,i=Math.floor(t*e),o=Math.floor(s*e),r=this.options.splitChannels?this.buffer.numberOfChannels:1;this.fft||(this.fft=new n(this.fftSamples,e,this.windowFunc,this.alpha));let l=this.noverlap;if(!l){const e=(o-i)/((s-t)*this.getPixelsPerSecond());l=Math.max(0,Math.round(this.fftSamples-e))}const a=.5*this.fftSamples;l=Math.min(l,a);const h=Math.max(64,.25*this.fftSamples),c=Math.max(h,this.fftSamples-l),d=[];console.log(`     - Processing ${(s-t).toFixed(1)}s segment (${o-i} samples)`),console.log(`     - FFT size: ${this.fftSamples}, hop size: ${c}, channels: ${r}`);const u=performance.now();let f=0;for(let t=0;t<r;t++){const s=this.buffer.getChannelData(t),r=[];for(let t=i;t+this.fftSamples<o;t+=c){const i=s.slice(t,t+this.fftSamples);let o=this.fft.calculateSpectrum(i);f++;const n=this.getFilterBank(e);n&&(o=this.applyFilterBank(o,n));const l=new Uint8Array(o.length),a=this.gainDB+this.rangeDB;for(let e=0;e<o.length;e++){const t=o[e]>1e-12?o[e]:1e-12,s=20*Math.log10(t);s<-a?l[e]=0:s>-this.gainDB?l[e]=255:l[e]=Math.round((s+this.gainDB)/this.rangeDB*255)}r.push(l)}d.push(r)}const g=performance.now();return console.log(`     - ⏱️ Main thread processed ${f} FFTs in ${(g-u).toFixed(1)}ms`),d}))}renderSegment(t){return e(this,void 0,void 0,(function*(){var e;const s=t.endPixel-t.startPixel,i=this.height*t.frequencies.length,o=document.createElement("canvas");o.width=Math.round(s),o.height=Math.round(i),o.style.position="absolute",o.style.left=`${t.startPixel}px`,o.style.top="0",o.style.width=`${s}px`,o.style.height=`${i}px`;const r=o.getContext("2d");if(!r)return;const n=(null===(e=this.buffer)||void 0===e?void 0:e.sampleRate)?this.buffer.sampleRate/2:0,l=this.frequencyMin,a=this.frequencyMax||n;for(let e=0;e<t.frequencies.length;e++)yield this.renderChannelToCanvas(t.frequencies[e],r,s,this.height,e*this.height,n,l,a);t.canvas=o,this.canvasContainer.appendChild(o)}))}renderChannelToCanvas(t,s,i,o,r,n,l,a){return e(this,void 0,void 0,(function*(){if(0===t.length)return;const e=t[0].length,h=new ImageData(t.length,e),c=h.data;for(let s=0;s<t.length;s++){const i=t[s];for(let o=0;o<e;o++){const r=Math.min(255,Math.max(0,i[o])),n=this.colorMap[r],l=4*((e-o-1)*t.length+s);c[l]=255*n[0],c[l+1]=255*n[1],c[l+2]=255*n[2],c[l+3]=255*n[3]}}const d=this.hzToScale(l)/this.hzToScale(n),u=this.hzToScale(a)/this.hzToScale(n),f=Math.min(1,u),g=o*f/u,p=r+o*(1-f/u),m=Math.round(e*(1-f)),w=Math.round(e*(f-d)),v=yield createImageBitmap(h,0,m,t.length,w);s.drawImage(v,0,p,i,g),"close"in v&&v.close()}))}clearAllSegments(){for(const e of this.segments.values())e.canvas&&e.canvas.remove();this.segments.clear()}getFilterBank(e){switch(this.scale){case"mel":return this.createFilterBank(this.numMelFilters,e,this.hzToMel,this.melToHz);case"logarithmic":return this.createFilterBank(this.numLogFilters,e,this.hzToLog,this.logToHz);case"bark":return this.createFilterBank(this.numBarkFilters,e,this.hzToBark,this.barkToHz);case"erb":return this.createFilterBank(this.numErbFilters,e,this.hzToErb,this.erbToHz);default:return null}}hzToMel(e){return 2595*Math.log10(1+e/700)}melToHz(e){return 700*(Math.pow(10,e/2595)-1)}hzToLog(e){return Math.log10(Math.max(1,e))}logToHz(e){return Math.pow(10,e)}hzToBark(e){let t=26.81*e/(1960+e)-.53;return t<2&&(t+=.15*(2-t)),t>20.1&&(t+=.22*(t-20.1)),t}barkToHz(e){return e<2&&(e=(e-.3)/.85),e>20.1&&(e=(e+4.422)/1.22),(e+.53)/(26.28-e)*1960}hzToErb(e){return r*Math.log10(1+.00437*e)}erbToHz(e){return(Math.pow(10,e/r)-1)/.00437}createFilterBank(e,t,s,i){const o=s(0),r=s(t/2),n=Array.from({length:e},(()=>Array(this.fftSamples/2+1).fill(0))),l=t/this.fftSamples;for(let t=0;t<e;t++){let s=i(o+t/e*(r-o)),a=Math.floor(s/l),h=a*l,c=(s-h)/((a+1)*l-h);n[t][a]=1-c,n[t][a+1]=c}return n}applyFilterBank(e,t){const s=t.length,i=Float32Array.from({length:s},(()=>0));for(let o=0;o<s;o++)for(let s=0;s<e.length;s++)i[o]+=e[s]*t[o][s];return i}freqType(e){return e>=1e3?(e/1e3).toFixed(1):Math.round(e)}unitType(e){return e>=1e3?"kHz":"Hz"}hzToScale(e){switch(this.scale){case"mel":return this.hzToMel(e);case"logarithmic":return this.hzToLog(e);case"bark":return this.hzToBark(e);case"erb":return this.hzToErb(e)}return e}scaleToHz(e){switch(this.scale){case"mel":return this.melToHz(e);case"logarithmic":return this.logToHz(e);case"bark":return this.barkToHz(e);case"erb":return this.erbToHz(e)}return e}getLabelFrequency(e,t){const s=this.hzToScale(this.frequencyMin),i=this.hzToScale(this.frequencyMax);return this.scaleToHz(s+e/t*(i-s))}loadLabels(e,t,s,i,o,r,n,l,a){e=e||"rgba(68,68,68,0)",t=t||"12px",s=s||"12px",i=i||"Helvetica",o=o||"#fff",r=r||"#fff",n=n||"center";const h=this.height||512,c=h/256*5;this.frequencyMin;this.frequencyMax;const d=this.labelsEl.getContext("2d"),u=window.devicePixelRatio;if(this.labelsEl.height=this.height*a*u,this.labelsEl.width=55*u,d.scale(u,u),d)for(let l=0;l<a;l++){let a;for(d.fillStyle=e,d.fillRect(0,l*h,55,(1+l)*h),d.fill(),a=0;a<=c;a++){d.textAlign=n,d.textBaseline="middle";const e=this.getLabelFrequency(a,c),u=this.freqType(e),f=this.unitType(e),g=16;let p=(1+l)*h-a/c*h;p=Math.min(Math.max(p,l*h+10),(1+l)*h-10),d.fillStyle=r,d.font=s+" "+i,d.fillText(f,g+24,p),d.fillStyle=o,d.font=t+" "+i,d.fillText(u.toString(),g,p)}}}render(t){return e(this,void 0,void 0,(function*(){this.buffer=t,this.pixelsPerSecond=this.getPixelsPerSecond(),this.frequencyMax=this.frequencyMax||t.sampleRate/2;const e=this.options.splitChannels?t.numberOfChannels:1;this.wrapper.style.height=this.height*e+"px",this.clearAllSegments(),this.options.labels&&this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",e),this.scheduleRender(),this.emit("ready")}))}destroy(){this.unAll(),this.renderTimeout&&(clearTimeout(this.renderTimeout),this.renderTimeout=null),this.qualityUpdateTimeout&&(clearTimeout(this.qualityUpdateTimeout),this.qualityUpdateTimeout=null),this.stopProgressiveLoading(),this.worker&&(this.worker.terminate(),this.worker=null);for(const[e,t]of this.workerPromises)t.reject(new Error("Plugin destroyed"));this.workerPromises.clear(),this.clearAllSegments(),this.canvasContainer&&(this.canvasContainer.remove(),this.canvasContainer=null),this.wrapper&&(this.wrapper.remove(),this.wrapper=null),this.labelsEl&&(this.labelsEl.remove(),this.labelsEl=null),this.container=null,this.buffer=null,this.fft=null,this.isRendering=!1,this.currentPosition=0,this.pixelsPerSecond=0,super.destroy()}getWidth(){var e,t;return(null===(t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper())||void 0===t?void 0:t.offsetWidth)||0}getWrapperWidth(){var e,t;return(null===(t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper())||void 0===t?void 0:t.clientWidth)||0}getPixelsPerSecond(){var e;const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.options.minPxPerSec;if(t&&t>0)return console.log(`  📏 Using minPxPerSec: ${t}`),t;if(this.buffer){const e=this.getWidth(),t=e>0?e/this.buffer.duration:100,s=Math.max(t,50);return console.log(`  📏 Calculated pxPerSec: ${t.toFixed(2)} (width: ${e}px, duration: ${this.buffer.duration.toFixed(1)}s)`),console.log(`  📏 Enforced minimum: 50, final: ${s.toFixed(2)}`),console.log(`  📏 This means ${(e/s).toFixed(1)}s of audio will be visible on screen`),s}return console.log("  📏 Using default fallback: 50"),50}stopProgressiveLoading(){console.log("🛑 Progressive loading stopped by user"),this.isProgressiveLoading=!1,this.progressiveLoadTimeout&&(clearTimeout(this.progressiveLoadTimeout),this.progressiveLoadTimeout=null)}enableProgressiveLoading(){this.progressiveLoading?this.isProgressiveLoading?console.log("⚠️ Progressive loading is already running"):(console.log("▶️ Progressive loading started manually"),this.startProgressiveLoading()):console.log("⚠️ Progressive loading is disabled in options")}}export{l as default};
