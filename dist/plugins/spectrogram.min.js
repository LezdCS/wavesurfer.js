!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):((e="undefined"!=typeof globalThis?globalThis:e||self).WaveSurfer=e.WaveSurfer||{},e.WaveSurfer.Spectrogram=t())}(this,(function(){"use strict";var e="undefined"!=typeof document?document.currentScript:null;function t(e,t,s,i){return new(s||(s=Promise))((function(n,r){function a(e){try{l(i.next(e))}catch(e){r(e)}}function o(e){try{l(i.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(a,o)}l((i=i.apply(e,t||[])).next())}))}let s;"function"==typeof SuppressedError&&SuppressedError;const i="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&i.decode();let n=null;function r(){return null!==n&&0!==n.byteLength||(n=new Uint8Array(s.memory.buffer)),n}function a(e,t){return e>>>=0,i.decode(r().subarray(e,e+t))}let o=0;const l="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},h="function"==typeof l.encodeInto?function(e,t){return l.encodeInto(e,t)}:function(e,t){const s=l.encode(e);return t.set(s),{read:e.length,written:s.length}};function c(e,t,s){if(void 0===s){const s=l.encode(e),i=t(s.length,1)>>>0;return r().subarray(i,i+s.length).set(s),o=s.length,i}let i=e.length,n=t(i,1)>>>0;const a=r();let c=0;for(;c<i;c++){const t=e.charCodeAt(c);if(t>127)break;a[n+c]=t}if(c!==i){0!==c&&(e=e.slice(c)),n=s(n,i,i=c+3*e.length,1)>>>0;const t=r().subarray(n+c,n+i);c+=h(e,t).written,n=s(n,i,c,1)>>>0}return o=c,n}let u=null;function f(){return(null===u||!0===u.buffer.detached||void 0===u.buffer.detached&&u.buffer!==s.memory.buffer)&&(u=new DataView(s.memory.buffer)),u}function d(e){const t=s.__wbindgen_export_3.get(e);return s.__externref_table_dealloc(e),t}let p=null;function w(){return null!==p&&0!==p.byteLength||(p=new Float32Array(s.memory.buffer)),p}function m(e,t){const s=t(4*e.length,4)>>>0;return w().set(e,s/4),o=e.length,s}function g(e,t){return e>>>=0,w().subarray(e/4,e/4+t)}function b(e,t,i){const n=m(e,s.__wbindgen_malloc),a=o,l=s.db_to_color_indices(n,a,t,i);var h,c,u=(h=l[0],c=l[1],h>>>=0,r().subarray(h/1,h/1+c)).slice();return s.__wbindgen_free(l[0],1*l[1],1),u}const _="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>s.__wbg_wasmfft_free(e>>>0,1)));class v{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,_.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_wasmfft_free(e,0)}constructor(e,t,i){const n=c(t,s.__wbindgen_malloc,s.__wbindgen_realloc),r=o,a=s.wasmfft_new(e,n,r,null==i?4294967297:Math.fround(i));if(a[2])throw d(a[1]);return this.__wbg_ptr=a[0]>>>0,_.register(this,this.__wbg_ptr,this),this}calculate_spectrum(e){const t=m(e,s.__wbindgen_malloc),i=o,n=s.wasmfft_calculate_spectrum(this.__wbg_ptr,t,i);if(n[3])throw d(n[2]);var r=g(n[0],n[1]).slice();return s.__wbindgen_free(n[0],4*n[1],4),r}get size(){return s.wasmfft_size(this.__wbg_ptr)>>>0}}const y="undefined"==typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry((e=>s.__wbg_wasmfilterbank_free(e>>>0,1)));class M{__destroy_into_raw(){const e=this.__wbg_ptr;return this.__wbg_ptr=0,y.unregister(this),e}free(){const e=this.__destroy_into_raw();s.__wbg_wasmfilterbank_free(e,0)}constructor(e,t,i,n){const r=c(n,s.__wbindgen_malloc,s.__wbindgen_realloc),a=o,l=s.wasmfilterbank_new(e,t,i,r,a);if(l[2])throw d(l[1]);return this.__wbg_ptr=l[0]>>>0,y.register(this,this.__wbg_ptr,this),this}apply(e){const t=m(e,s.__wbindgen_malloc),i=o,n=s.wasmfilterbank_apply(this.__wbg_ptr,t,i);if(n[3])throw d(n[2]);var r=g(n[0],n[1]).slice();return s.__wbindgen_free(n[0],4*n[1],4),r}}async function F(t){if(void 0!==s)return s;void 0!==t&&(Object.getPrototypeOf(t)===Object.prototype?({module_or_path:t}=t):console.warn("using deprecated parameters for the initialization function; pass a single object instead")),void 0===t&&(t=new URL("wavesurfer_fft_bg.wasm","undefined"==typeof document&&"undefined"==typeof location?require("url").pathToFileURL(__filename).href:"undefined"==typeof document?location.href:e&&"SCRIPT"===e.tagName.toUpperCase()&&e.src||new URL("spectrogram.min.js",document.baseURI).href));const i=function(){const e={wbg:{}};return e.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,t){let i,n;try{i=e,n=t,console.error(a(e,t))}finally{s.__wbindgen_free(i,n,1)}},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,t){const i=c(t.stack,s.__wbindgen_malloc,s.__wbindgen_realloc),n=o;f().setInt32(e+4,n,!0),f().setInt32(e+0,i,!0)},e.wbg.__wbindgen_init_externref_table=function(){const e=s.__wbindgen_export_3,t=e.grow(4);e.set(0,void 0),e.set(t+0,void 0),e.set(t+1,null),e.set(t+2,!0),e.set(t+3,!1)},e.wbg.__wbindgen_string_new=function(e,t){return a(e,t)},e.wbg.__wbindgen_throw=function(e,t){throw new Error(a(e,t))},e}();("string"==typeof t||"function"==typeof Request&&t instanceof Request||"function"==typeof URL&&t instanceof URL)&&(t=fetch(t));const{instance:r,module:l}=await async function(e,t){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,t)}catch(t){if("application/wasm"==e.headers.get("Content-Type"))throw t;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",t)}const s=await e.arrayBuffer();return await WebAssembly.instantiate(s,t)}{const s=await WebAssembly.instantiate(e,t);return s instanceof WebAssembly.Instance?{instance:s,module:e}:s}}(await t,i);return function(e,t){return s=e.exports,F.__wbindgen_wasm_module=t,u=null,p=null,n=null,s.__wbindgen_start(),s}(r,l)}const S=1e3*Math.log(10)/107.939;function T(e){return 2595*Math.log10(1+e/700)}function W(e){return 700*(Math.pow(10,e/2595)-1)}function A(e){return Math.log10(Math.max(1,e))}function k(e){return Math.pow(10,e)}function x(e){let t=26.81*e/(1960+e)-.53;return t<2&&(t+=.15*(2-t)),t>20.1&&(t+=.22*(t-20.1)),t}function C(e){return e<2&&(e=(e-.3)/.85),e>20.1&&(e=(e+4.422)/1.22),(e+.53)/(26.28-e)*1960}function R(e){return S*Math.log10(1+.00437*e)}function D(e){return(Math.pow(10,e/S)-1)/.00437}function B(e,t){switch(t){case"mel":return T(e);case"logarithmic":return A(e);case"bark":return x(e);case"erb":return R(e);default:return e}}function q(e,t,s,i,n){const r=i(0),a=i(s/2),o=Array.from({length:e},(()=>Array(t/2+1).fill(0))),l=s/t;for(let t=0;t<e;t++){let s=n(r+t/e*(a-r)),i=Math.floor(s/l),h=i*l,c=(s-h)/((i+1)*l-h);o[t][i]=1-c,o[t][i+1]=c}return o}function E(e,t){const s=t.length,i=Float32Array.from({length:s},(()=>0));for(let n=0;n<s;n++)for(let s=0;s<e.length;s++)i[n]+=e[s]*t[n][s];return i}function I(e,t,s,i){switch(this.bufferSize=e,this.sampleRate=t,this.bandwidth=2/e*(t/2),this.sinTable=new Float32Array(e),this.cosTable=new Float32Array(e),this.windowValues=new Float32Array(e),this.reverseTable=new Uint32Array(e),this.peakBand=0,this.peak=0,s){case"bartlett":for(n=0;n<e;n++)this.windowValues[n]=2/(e-1)*((e-1)/2-Math.abs(n-(e-1)/2));break;case"bartlettHann":for(n=0;n<e;n++)this.windowValues[n]=.62-.48*Math.abs(n/(e-1)-.5)-.38*Math.cos(2*Math.PI*n/(e-1));break;case"blackman":for(i=i||.16,n=0;n<e;n++)this.windowValues[n]=(1-i)/2-.5*Math.cos(2*Math.PI*n/(e-1))+i/2*Math.cos(4*Math.PI*n/(e-1));break;case"cosine":for(n=0;n<e;n++)this.windowValues[n]=Math.cos(Math.PI*n/(e-1)-Math.PI/2);break;case"gauss":for(i=i||.25,n=0;n<e;n++)this.windowValues[n]=Math.pow(Math.E,-.5*Math.pow((n-(e-1)/2)/(i*(e-1)/2),2));break;case"hamming":for(n=0;n<e;n++)this.windowValues[n]=.54-.46*Math.cos(2*Math.PI*n/(e-1));break;case"hann":case void 0:for(n=0;n<e;n++)this.windowValues[n]=.5*(1-Math.cos(2*Math.PI*n/(e-1)));break;case"lanczoz":for(n=0;n<e;n++)this.windowValues[n]=Math.sin(Math.PI*(2*n/(e-1)-1))/(Math.PI*(2*n/(e-1)-1));break;case"rectangular":for(n=0;n<e;n++)this.windowValues[n]=1;break;case"triangular":for(n=0;n<e;n++)this.windowValues[n]=2/e*(e/2-Math.abs(n-(e-1)/2));break;default:throw Error("No such window function '"+s+"'")}for(var n,r=1,a=e>>1;r<e;){for(n=0;n<r;n++)this.reverseTable[n+r]=this.reverseTable[n]+a;r<<=1,a>>=1}for(n=0;n<e;n++)this.sinTable[n]=Math.sin(-Math.PI/n),this.cosTable[n]=Math.cos(-Math.PI/n);this.calculateSpectrum=function(e){var t,s,i,n=this.bufferSize,r=this.cosTable,a=this.sinTable,o=this.reverseTable,l=new Float32Array(n),h=new Float32Array(n),c=2/this.bufferSize,u=Math.sqrt,f=new Float32Array(n/2),d=Math.floor(Math.log(n)/Math.LN2);if(Math.pow(2,d)!==n)throw"Invalid buffer size, must be a power of 2.";if(n!==e.length)throw"Supplied buffer is not the same size as defined FFT. FFT Size: "+n+" Buffer Size: "+e.length;for(var p,w,m,g,b,_,v,y,M=1,F=0;F<n;F++)l[F]=e[o[F]]*this.windowValues[o[F]],h[F]=0;for(;M<n;){p=r[M],w=a[M],m=1,g=0;for(var S=0;S<M;S++){for(F=S;F<n;)_=m*l[b=F+M]-g*h[b],v=m*h[b]+g*l[b],l[b]=l[F]-_,h[b]=h[F]-v,l[F]+=_,h[F]+=v,F+=M<<1;m=(y=m)*p-g*w,g=y*w+g*p}M<<=1}F=0;for(var T=n/2;F<T;F++)(i=c*u((t=l[F])*t+(s=h[F])*s))>this.peak&&(this.peakBand=F,this.peak=i),f[F]=i;return f}}class z{constructor(){this.listeners={}}on(e,t,s){if(this.listeners[e]||(this.listeners[e]=new Set),this.listeners[e].add(t),null==s?void 0:s.once){const s=()=>{this.un(e,s),this.un(e,t)};return this.on(e,s),s}return()=>this.un(e,t)}un(e,t){var s;null===(s=this.listeners[e])||void 0===s||s.delete(t)}once(e,t){return this.on(e,t,{once:!0})}unAll(){this.listeners={}}emit(e,...t){this.listeners[e]&&this.listeners[e].forEach((e=>e(...t)))}}class U extends z{constructor(e){super(),this.subscriptions=[],this.isDestroyed=!1,this.options=e}onInit(){}_init(e){this.isDestroyed&&(this.subscriptions=[],this.isDestroyed=!1),this.wavesurfer=e,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((e=>e())),this.subscriptions=[],this.isDestroyed=!0,this.wavesurfer=void 0}}function L(e,t){const s=t.xmlns?document.createElementNS(t.xmlns,e):document.createElement(e);for(const[e,i]of Object.entries(t))if("children"===e&&i)for(const[e,t]of Object.entries(i))t instanceof Node?s.appendChild(t):"string"==typeof t?s.appendChild(document.createTextNode(t)):s.appendChild(L(e,t));else"style"===e?Object.assign(s.style,i):"textContent"===e?s.textContent=i:s.setAttribute(e,i.toString());return s}function P(e,t,s){const i=L(e,t||{});return null==s||s.appendChild(i),i}class N extends U{static create(e){return new N(e||{})}constructor(e){var t,s;if(super(e),this.canvases=[],this.fft=null,this.wasmFFT=null,this.wasmFilterBank=null,this.isWasmAvailable=!1,this.useWasm=!0,this.cachedFrequencies=null,this.cachedResampledData=null,this.cachedBuffer=null,this.cachedWidth=0,this.renderTimeout=null,this.isRendering=!1,this.lastZoomLevel=0,this.renderThrottleMs=50,this.zoomThreshold=.05,this.drawnCanvases={},this.pendingBitmaps=new Set,this.isScrollable=!1,this.scrollUnsubscribe=null,this._onWrapperClick=e=>{const t=this.wrapper.getBoundingClientRect(),s=(e.clientX-t.left)/t.width;this.emit("click",s)},this.frequenciesDataUrl=e.frequenciesDataUrl,this.frequenciesDataUrl&&!e.sampleRate)throw new Error("sampleRate option is required when using frequenciesDataUrl");if(this.container="string"==typeof e.container?document.querySelector(e.container):e.container,this.useWasm=!1!==e.useWasm,e.colorMap&&"string"!=typeof e.colorMap){if(e.colorMap.length<256)throw new Error("Colormap must contain 256 elements");for(let t=0;t<e.colorMap.length;t++){if(4!==e.colorMap[t].length)throw new Error("ColorMap entries must contain 4 values")}this.colorMap=e.colorMap}else switch(this.colorMap=e.colorMap||"roseus",this.colorMap){case"gray":this.colorMap=[];for(let e=0;e<256;e++){const t=(255-e)/256;this.colorMap.push([t,t,t,1])}break;case"igray":this.colorMap=[];for(let e=0;e<256;e++){const t=e/256;this.colorMap.push([t,t,t,1])}break;case"roseus":this.colorMap=[[.004528,.004341,.004307,1],[.005625,.006156,.00601,1],[.006628,.008293,.008161,1],[.007551,.010738,.01079,1],[.008382,.013482,.013941,1],[.009111,.01652,.017662,1],[.009727,.019846,.022009,1],[.010223,.023452,.027035,1],[.010593,.027331,.032799,1],[.010833,.031475,.039361,1],[.010941,.035875,.046415,1],[.010918,.04052,.053597,1],[.010768,.045158,.060914,1],[.010492,.049708,.068367,1],[.010098,.054171,.075954,1],[.009594,.058549,.083672,1],[.008989,.06284,.091521,1],[.008297,.067046,.099499,1],[.00753,.071165,.107603,1],[.006704,.075196,.11583,1],[.005838,.07914,.124178,1],[.004949,.082994,.132643,1],[.004062,.086758,.141223,1],[.003198,.09043,.149913,1],[.002382,.09401,.158711,1],[.001643,.097494,.167612,1],[.001009,.100883,.176612,1],[514e-6,.104174,.185704,1],[187e-6,.107366,.194886,1],[66e-6,.110457,.204151,1],[186e-6,.113445,.213496,1],[587e-6,.116329,.222914,1],[.001309,.119106,.232397,1],[.002394,.121776,.241942,1],[.003886,.124336,.251542,1],[.005831,.126784,.261189,1],[.008276,.12912,.270876,1],[.011268,.131342,.280598,1],[.014859,.133447,.290345,1],[.0191,.135435,.300111,1],[.024043,.137305,.309888,1],[.029742,.139054,.319669,1],[.036252,.140683,.329441,1],[.043507,.142189,.339203,1],[.050922,.143571,.348942,1],[.058432,.144831,.358649,1],[.066041,.145965,.368319,1],[.073744,.146974,.377938,1],[.081541,.147858,.387501,1],[.089431,.148616,.396998,1],[.097411,.149248,.406419,1],[.105479,.149754,.415755,1],[.113634,.150134,.424998,1],[.121873,.150389,.434139,1],[.130192,.150521,.443167,1],[.138591,.150528,.452075,1],[.147065,.150413,.460852,1],[.155614,.150175,.469493,1],[.164232,.149818,.477985,1],[.172917,.149343,.486322,1],[.181666,.148751,.494494,1],[.190476,.148046,.502493,1],[.199344,.147229,.510313,1],[.208267,.146302,.517944,1],[.217242,.145267,.52538,1],[.226264,.144131,.532613,1],[.235331,.142894,.539635,1],[.24444,.141559,.546442,1],[.253587,.140131,.553026,1],[.262769,.138615,.559381,1],[.271981,.137016,.5655,1],[.281222,.135335,.571381,1],[.290487,.133581,.577017,1],[.299774,.131757,.582404,1],[.30908,.129867,.587538,1],[.318399,.12792,.592415,1],[.32773,.125921,.597032,1],[.337069,.123877,.601385,1],[.346413,.121793,.605474,1],[.355758,.119678,.609295,1],[.365102,.11754,.612846,1],[.374443,.115386,.616127,1],[.383774,.113226,.619138,1],[.393096,.111066,.621876,1],[.402404,.108918,.624343,1],[.411694,.106794,.62654,1],[.420967,.104698,.628466,1],[.430217,.102645,.630123,1],[.439442,.100647,.631513,1],[.448637,.098717,.632638,1],[.457805,.096861,.633499,1],[.46694,.095095,.6341,1],[.47604,.093433,.634443,1],[.485102,.091885,.634532,1],[.494125,.090466,.63437,1],[.503104,.08919,.633962,1],[.512041,.088067,.633311,1],[.520931,.087108,.63242,1],[.529773,.086329,.631297,1],[.538564,.085738,.629944,1],[.547302,.085346,.628367,1],[.555986,.085162,.626572,1],[.564615,.08519,.624563,1],[.573187,.085439,.622345,1],[.581698,.085913,.619926,1],[.590149,.086615,.617311,1],[.598538,.087543,.614503,1],[.606862,.0887,.611511,1],[.61512,.090084,.608343,1],[.623312,.09169,.605001,1],[.631438,.093511,.601489,1],[.639492,.095546,.597821,1],[.647476,.097787,.593999,1],[.655389,.100226,.590028,1],[.66323,.102856,.585914,1],[.670995,.105669,.581667,1],[.678686,.108658,.577291,1],[.686302,.111813,.57279,1],[.69384,.115129,.568175,1],[.7013,.118597,.563449,1],[.708682,.122209,.558616,1],[.715984,.125959,.553687,1],[.723206,.12984,.548666,1],[.730346,.133846,.543558,1],[.737406,.13797,.538366,1],[.744382,.142209,.533101,1],[.751274,.146556,.527767,1],[.758082,.151008,.522369,1],[.764805,.155559,.516912,1],[.771443,.160206,.511402,1],[.777995,.164946,.505845,1],[.784459,.169774,.500246,1],[.790836,.174689,.494607,1],[.797125,.179688,.488935,1],[.803325,.184767,.483238,1],[.809435,.189925,.477518,1],[.815455,.19516,.471781,1],[.821384,.200471,.466028,1],[.827222,.205854,.460267,1],[.832968,.211308,.454505,1],[.838621,.216834,.448738,1],[.844181,.222428,.442979,1],[.849647,.22809,.43723,1],[.855019,.233819,.431491,1],[.860295,.239613,.425771,1],[.865475,.245471,.420074,1],[.870558,.251393,.414403,1],[.875545,.25738,.408759,1],[.880433,.263427,.403152,1],[.885223,.269535,.397585,1],[.889913,.275705,.392058,1],[.894503,.281934,.386578,1],[.898993,.288222,.381152,1],[.903381,.294569,.375781,1],[.907667,.300974,.370469,1],[.911849,.307435,.365223,1],[.915928,.313953,.360048,1],[.919902,.320527,.354948,1],[.923771,.327155,.349928,1],[.927533,.333838,.344994,1],[.931188,.340576,.340149,1],[.934736,.347366,.335403,1],[.938175,.354207,.330762,1],[.941504,.361101,.326229,1],[.944723,.368045,.321814,1],[.947831,.375039,.317523,1],[.950826,.382083,.313364,1],[.953709,.389175,.309345,1],[.956478,.396314,.305477,1],[.959133,.403499,.301766,1],[.961671,.410731,.298221,1],[.964093,.418008,.294853,1],[.966399,.425327,.291676,1],[.968586,.43269,.288696,1],[.970654,.440095,.285926,1],[.972603,.44754,.28338,1],[.974431,.455025,.281067,1],[.976139,.462547,.279003,1],[.977725,.470107,.277198,1],[.979188,.477703,.275666,1],[.980529,.485332,.274422,1],[.981747,.492995,.273476,1],[.98284,.50069,.272842,1],[.983808,.508415,.272532,1],[.984653,.516168,.27256,1],[.985373,.523948,.272937,1],[.985966,.531754,.273673,1],[.986436,.539582,.274779,1],[.98678,.547434,.276264,1],[.986998,.555305,.278135,1],[.987091,.563195,.280401,1],[.987061,.5711,.283066,1],[.986907,.579019,.286137,1],[.986629,.58695,.289615,1],[.986229,.594891,.293503,1],[.985709,.602839,.297802,1],[.985069,.610792,.302512,1],[.98431,.618748,.307632,1],[.983435,.626704,.313159,1],[.982445,.634657,.319089,1],[.981341,.642606,.32542,1],[.98013,.650546,.332144,1],[.978812,.658475,.339257,1],[.977392,.666391,.346753,1],[.97587,.67429,.354625,1],[.974252,.68217,.362865,1],[.972545,.690026,.371466,1],[.97075,.697856,.380419,1],[.968873,.705658,.389718,1],[.966921,.713426,.399353,1],[.964901,.721157,.409313,1],[.962815,.728851,.419594,1],[.960677,.7365,.430181,1],[.95849,.744103,.44107,1],[.956263,.751656,.452248,1],[.954009,.759153,.463702,1],[.951732,.766595,.475429,1],[.949445,.773974,.487414,1],[.947158,.781289,.499647,1],[.944885,.788535,.512116,1],[.942634,.795709,.524811,1],[.940423,.802807,.537717,1],[.938261,.809825,.550825,1],[.936163,.81676,.564121,1],[.934146,.823608,.577591,1],[.932224,.830366,.59122,1],[.930412,.837031,.604997,1],[.928727,.843599,.618904,1],[.927187,.850066,.632926,1],[.925809,.856432,.647047,1],[.92461,.862691,.661249,1],[.923607,.868843,.675517,1],[.92282,.874884,.689832,1],[.922265,.880812,.704174,1],[.921962,.886626,.718523,1],[.92193,.892323,.732859,1],[.922183,.897903,.747163,1],[.922741,.903364,.76141,1],[.92362,.908706,.77558,1],[.924837,.913928,.789648,1],[.926405,.919031,.80359,1],[.92834,.924015,.817381,1],[.930655,.928881,.830995,1],[.93336,.933631,.844405,1],[.936466,.938267,.857583,1],[.939982,.942791,.870499,1],[.943914,.947207,.883122,1],[.948267,.951519,.895421,1],[.953044,.955732,.907359,1],[.958246,.959852,.918901,1],[.963869,.963887,.930004,1],[.969909,.967845,.940623,1],[.976355,.971737,.950704,1],[.983195,.97558,.960181,1],[.990402,.979395,.968966,1],[.99793,.983217,.97692,1]];break;default:throw Error("No such colormap '"+this.colorMap+"'")}this.fftSamples=e.fftSamples||512,this.height=e.height||200,this.noverlap=e.noverlap||null,this.windowFunc=e.windowFunc||"hann",this.alpha=e.alpha,this.frequencyMin=e.frequencyMin||0,this.frequencyMax=e.frequencyMax||0,this.gainDB=null!==(t=e.gainDB)&&void 0!==t?t:20,this.rangeDB=null!==(s=e.rangeDB)&&void 0!==s?s:80,this.scale=e.scale||"mel",this.numMelFilters=this.fftSamples/2,this.numLogFilters=this.fftSamples/2,this.numBarkFilters=this.fftSamples/2,this.numErbFilters=this.fftSamples/2,e.maxCanvasWidth&&(N.MAX_CANVAS_WIDTH=e.maxCanvasWidth),"fast"===e.performanceMode?(this.renderThrottleMs=100,this.zoomThreshold=.2,e.fftSamples||(this.fftSamples=256)):(this.renderThrottleMs=50,this.zoomThreshold=.05),this.createWrapper(),this.createCanvas()}onInit(){this.wrapper||this.createWrapper(),this.canvasContainer||this.createCanvas(),this.useWasm&&this.initializeWasm(),this.container=this.wavesurfer.getWrapper(),this.container.appendChild(this.wrapper),this.wavesurfer.options.fillParent&&Object.assign(this.wrapper.style,{width:"100%",overflowX:"hidden",overflowY:"hidden"}),this.subscriptions.push(this.wavesurfer.on("redraw",(()=>this.throttledRender()))),this.wavesurfer.getDecodedData()&&setTimeout((()=>{this.throttledRender()}),0)}initializeWasm(){try{F().then((e=>{console.log("‚úÖ WASM module initialized for spectrogram plugin:",e),this.isWasmAvailable=!0})).catch((e=>{console.warn("‚ùå Async WASM init failed:",e.message),console.log("Will use JavaScript fallback for FFT calculations"),this.isWasmAvailable=!1}))}catch(e){console.warn("‚ùå WASM FFT not available, using JavaScript fallback:",e.message),this.isWasmAvailable=!1}}destroy(){if(this.unAll(),this.wavesurfer&&("function"==typeof this._onReady&&this.wavesurfer.un("ready",this._onReady),"function"==typeof this._onRender&&this.wavesurfer.un("redraw",this._onRender)),this.renderTimeout&&(clearTimeout(this.renderTimeout),this.renderTimeout=null),this.scrollUnsubscribe&&(this.scrollUnsubscribe(),this.scrollUnsubscribe=null),this.pendingBitmaps.clear(),this.cachedFrequencies=null,this.cachedResampledData=null,this.cachedBuffer=null,this.wasmFFT){try{this.wasmFFT.free(),console.log("üßπ WASM FFT memory cleaned up")}catch(e){console.warn("Failed to clean up WASM FFT:",e)}this.wasmFFT=null}if(this.wasmFilterBank){try{this.wasmFilterBank.free(),console.log("üßπ WASM FilterBank memory cleaned up")}catch(e){console.warn("Failed to clean up WASM FilterBank:",e)}this.wasmFilterBank=null}this.clearCanvases(),this.canvasContainer&&(this.canvasContainer.remove(),this.canvasContainer=null),this.wrapper&&(this.wrapper.remove(),this.wrapper=null),this.labelsEl&&(this.labelsEl.remove(),this.labelsEl=null),this.container=null,this.isRendering=!1,this.lastZoomLevel=0,this.fft=null,this.wasmFFT=null,this.wasmFilterBank=null,this.isWasmAvailable=!1,this.wavesurfer=null,this.util=null,this.options=null,super.destroy()}loadFrequenciesData(e){return t(this,void 0,void 0,(function*(){const t=yield fetch(e);if(!t.ok)throw new Error("Unable to fetch frequencies data");const s=yield t.json();this.drawSpectrogram(s)}))}clearCache(){if(this.cachedFrequencies=null,this.cachedResampledData=null,this.cachedBuffer=null,this.cachedWidth=0,this.lastZoomLevel=0,this.wasmFFT){try{this.wasmFFT.free()}catch(e){console.warn("Failed to free WASM FFT during cache clear:",e)}this.wasmFFT=null}if(this.wasmFilterBank){try{this.wasmFilterBank.free()}catch(e){console.warn("Failed to free WASM FilterBank during cache clear:",e)}this.wasmFilterBank=null}this.fft=null}createWrapper(){this.wrapper=P("div",{style:{display:"block",position:"relative",userSelect:"none"}}),this.options.labels&&(this.labelsEl=P("canvas",{part:"spec-labels",style:{position:"absolute",zIndex:9,width:"55px",height:"100%"}},this.wrapper)),this.wrapper.removeEventListener("click",this._onWrapperClick),this.wrapper.addEventListener("click",this._onWrapperClick)}createCanvas(){this.canvasContainer=P("div",{style:{position:"absolute",left:0,top:0,width:"100%",height:"100%",zIndex:4}},this.wrapper)}createSingleCanvas(e,t,s){const i=P("canvas",{style:{position:"absolute",left:`${Math.round(s)}px`,top:"0",width:`${e}px`,height:`${t}px`,zIndex:4}});return i.width=Math.round(e),i.height=Math.round(t),this.canvasContainer.appendChild(i),i}clearCanvases(){this.canvases.forEach((e=>e.remove())),this.canvases=[],this.drawnCanvases={}}clearExcessCanvases(){Object.keys(this.drawnCanvases).length>N.MAX_NODES&&this.clearCanvases()}throttledRender(){var e;if(this.renderTimeout&&clearTimeout(this.renderTimeout),this.isRendering)return;const t=(null===(e=this.wavesurfer)||void 0===e?void 0:e.options.minPxPerSec)||0;Math.abs(t-this.lastZoomLevel)/Math.max(t,this.lastZoomLevel,1)<this.zoomThreshold&&this.cachedFrequencies?this.renderTimeout=window.setTimeout((()=>{this.fastRender()}),this.renderThrottleMs):this.renderTimeout=window.setTimeout((()=>{this.render()}),this.renderThrottleMs)}render(){var e,t;if(!this.isRendering){this.isRendering=!0;try{if(this.frequenciesDataUrl)this.loadFrequenciesData(this.frequenciesDataUrl);else{const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getDecodedData();if(t)if(this.cachedBuffer===t&&this.cachedFrequencies)this.drawSpectrogram(this.cachedFrequencies);else{const e=this.getFrequencies(t);this.cachedFrequencies=e,this.cachedBuffer=t,this.drawSpectrogram(e)}}this.lastZoomLevel=(null===(t=this.wavesurfer)||void 0===t?void 0:t.options.minPxPerSec)||0}finally{this.isRendering=!1}}}fastRender(){var e;if(!this.isRendering&&this.cachedFrequencies){this.isRendering=!0;try{this.drawSpectrogram(this.cachedFrequencies),this.lastZoomLevel=(null===(e=this.wavesurfer)||void 0===e?void 0:e.options.minPxPerSec)||0}finally{this.isRendering=!1}}}drawSpectrogram(e){var t,s,i;isNaN(e[0][0])||(e=[e]),this.clearCanvases();const n=this.height*e.length;this.wrapper.style.height=n+"px";const r=this.getWidth(),a=Math.min(N.MAX_CANVAS_WIDTH,r);if(0===r||0===n)return;const o=Math.ceil(r/a);let l;const h=(null===(t=e[0])||void 0===t?void 0:t.length)||0;r!==h?this.cachedResampledData&&this.cachedWidth===r?l=this.cachedResampledData:(l=this.efficientResample(e,r),this.cachedResampledData=l,this.cachedWidth=r):l=e;const c=(null===(s=this.buffer)||void 0===s?void 0:s.sampleRate)?this.buffer.sampleRate/2:(this.options.sampleRate||0)/2,u=this.frequencyMin,f=this.frequencyMax,d=f>c,p=d?this.colorMap[this.colorMap.length-1]:null,w=e=>{if(e<0||e>=o)return;if(this.drawnCanvases[e])return;this.drawnCanvases[e]=!0;const t=e*a,s=Math.min(a,r-t);if(s<=0)return;const i=this.createSingleCanvas(s,n,t);this.canvases.push(i);const h=i.getContext("2d");if(h){d&&p&&(h.fillStyle=`rgba(${255*p[0]}, ${255*p[1]}, ${255*p[2]}, ${p[3]})`,h.fillRect(0,0,s,n));for(let e=0;e<l.length;e++)this.drawSpectrogramSegment(l[e],h,s,this.height,e*this.height,t,r,c,u,f)}};if(this.isScrollable=r>this.getWrapperWidth(),this.scrollUnsubscribe&&(this.scrollUnsubscribe(),this.scrollUnsubscribe=null),!this.isScrollable||o<=3)for(let e=0;e<o;e++)w(e);else{const e=()=>{var e;const t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper();if(!t)return;const s=t.scrollLeft||0,i=t.clientWidth||0,n=Math.max(0,s-.5*i),a=Math.min(r,s+1.5*i),l=Math.floor(n/r*o),h=Math.min(Math.ceil(a/r*o),o-1);Object.keys(this.drawnCanvases).length>N.MAX_NODES&&this.clearExcessCanvases();for(let e=l;e<=h;e++)w(e)};e();let t=null;const s=()=>{t&&clearTimeout(t),t=window.setTimeout(e,16)},n=null===(i=this.wavesurfer)||void 0===i?void 0:i.getWrapper();n&&(n.addEventListener("scroll",s,{passive:!0}),this.scrollUnsubscribe=()=>{n.removeEventListener("scroll",s),t&&clearTimeout(t)})}this.options.labels&&this.loadLabels(this.options.labelsBackground,"12px","12px","",this.options.labelsColor,this.options.labelsHzColor||this.options.labelsColor,"center","#specLabels",e.length),this.emit("ready")}drawSpectrogramSegment(e,t,s,i,n,r,a,o,l,h){const c=e[0].length,u=Math.floor(r/a*e.length),f=Math.min(Math.ceil((r+s)/a*e.length),e.length),d=e.slice(u,f);if(0===d.length)return;const p=d.length,w=new ImageData(p,c),m=w.data;"fast"===this.options.performanceMode&&c>1024?this.fillImageDataFast(m,d,p,c):this.fillImageDataQuality(m,d,p,c);const g=B(l,this.scale)/B(o,this.scale),b=B(h,this.scale)/B(o,this.scale),_=Math.min(1,b),v=createImageBitmap(w,0,Math.round(c*(1-_)),p,Math.round(c*(_-g)));this.pendingBitmaps.add(v),v.then((e=>{if(this.pendingBitmaps.delete(v),t.canvas.parentNode){const r=i*_/b,a=n+i*(1-_/b);t.drawImage(e,0,a,s,r),"close"in e&&e.close()}})).catch((e=>{this.pendingBitmaps.delete(v),console.warn("Failed to create bitmap for spectrogram:",e)}))}getWidth(){return this.wavesurfer.getWrapper().offsetWidth}getWrapperWidth(){var e,t;return(null===(t=null===(e=this.wavesurfer)||void 0===e?void 0:e.getWrapper())||void 0===t?void 0:t.clientWidth)||0}getFrequencies(e){var t,s;const i=this.fftSamples,n=(null!==(t=this.options.splitChannels)&&void 0!==t?t:null===(s=this.wavesurfer)||void 0===s?void 0:s.options.splitChannels)?e.numberOfChannels:1;if(this.frequencyMax=this.frequencyMax||e.sampleRate/2,!e)return;this.buffer=e;const r=e.sampleRate,a=[];let o=this.noverlap;if(!o){const t=this.getWidth(),s=e.length/t;o=Math.max(0,Math.round(i-s))}this.initializeFFT(r);let l=null,h=!1;if("linear"!==this.scale){if(this.isWasmAvailable&&this.wasmFFT&&!this.wasmFilterBank)try{this.wasmFilterBank=new M(this.fftSamples/2,this.fftSamples,r,this.scale),h=!0,console.log("‚úÖ WASM FilterBank initialized")}catch(e){console.warn("‚ö†Ô∏è Failed to create WASM FilterBank, using JS fallback:",e),h=!1}if(!h)switch(this.scale){case"mel":l=q(this.numMelFilters,this.fftSamples,r,T,W);break;case"logarithmic":l=q(this.numLogFilters,this.fftSamples,r,A,k);break;case"bark":l=q(this.numBarkFilters,this.fftSamples,r,x,C);break;case"erb":l=q(this.numErbFilters,this.fftSamples,r,R,D)}}const c=performance.now();let u=0;for(let t=0;t<n;t++){const s=e.getChannelData(t),n=[];let r=0;for(;r+i<s.length;){const e=s.slice(r,r+i);let t,a;if(this.isWasmAvailable&&this.wasmFFT)t=this.wasmFFT.calculate_spectrum(e),h&&this.wasmFilterBank&&(t=this.wasmFilterBank.apply(t));else{if(!this.fft)return console.error("No FFT available!"),[];t=this.fft.calculateSpectrum(e),l&&(t=E(t,l))}if(u++,this.isWasmAvailable&&this.wasmFFT)try{a=b(t,this.gainDB||20,this.rangeDB||80)}catch(e){console.warn("WASM color conversion failed, using JS fallback:",e),a=this.convertSpectrumToColors(t)}else a=this.convertSpectrumToColors(t);n.push(a),r+=i-o}a.push(n)}const f=performance.now(),d=this.isWasmAvailable&&this.wasmFFT?"WASM":"JS";return console.log(`üîß Spectrogram ${d} FFT calculation: ${u} FFTs in ${(f-c).toFixed(1)}ms`),a}initializeFFT(e){if(this.useWasm&&this.isWasmAvailable&&!this.wasmFFT)try{this.wasmFFT=new v(this.fftSamples,this.windowFunc||"hann",this.alpha),console.log("‚úÖ WASM FFT initialized for spectrogram plugin")}catch(e){console.warn("‚ö†Ô∏è Failed to create WASM FFT, falling back to JS:",e),this.isWasmAvailable=!1}this.isWasmAvailable||this.fft||(this.fft=new I(this.fftSamples,e,this.windowFunc,this.alpha))}convertSpectrumToColors(e){const t=new Uint8Array(e.length),s=this.gainDB+this.rangeDB;for(let i=0;i<e.length;i++){const n=e[i]>1e-12?e[i]:1e-12,r=20*Math.log10(n);r<-s?t[i]=0:r>-this.gainDB?t[i]=255:t[i]=Math.round((r+this.gainDB)/this.rangeDB*255)}return t}freqType(e){return e>=1e3?(e/1e3).toFixed(1):Math.round(e)}unitType(e){return e>=1e3?"kHz":"Hz"}getLabelFrequency(e,t){const s=B(this.frequencyMin,this.scale);return function(e,t){switch(t){case"mel":return W(e);case"logarithmic":return k(e);case"bark":return C(e);case"erb":return D(e);default:return e}}(s+e/t*(B(this.frequencyMax,this.scale)-s),this.scale)}loadLabels(e,t,s,i,n,r,a,o,l){e=e||"rgba(68,68,68,0)",t=t||"12px",s=s||"12px",i=i||"Helvetica",n=n||"#fff",r=r||"#fff",a=a||"center";const h=this.height||512,c=h/256*5;this.frequencyMin;this.frequencyMax;const u=this.labelsEl.getContext("2d"),f=window.devicePixelRatio;if(this.labelsEl.height=this.height*l*f,this.labelsEl.width=55*f,u.scale(f,f),u)for(let o=0;o<l;o++){let l;for(u.fillStyle=e,u.fillRect(0,o*h,55,(1+o)*h),u.fill(),l=0;l<=c;l++){u.textAlign=a,u.textBaseline="middle";const e=this.getLabelFrequency(l,c),f=this.freqType(e),d=this.unitType(e),p=16;let w=(1+o)*h-l/c*h;w=Math.min(Math.max(w,o*h+10),(1+o)*h-10),u.fillStyle=r,u.font=s+" "+i,u.fillText(d,p+24,w),u.fillStyle=n,u.font=t+" "+i,u.fillText(f,p,w)}}}efficientResample(e,t){return e.map((e=>this.resampleChannel(e,t)))}resampleChannel(e,t){var s;const i=e.length,n=(null===(s=e[0])||void 0===s?void 0:s.length)||0;if(i===t||0===t)return e;const r=i/t,a="fast"===this.options.performanceMode;if(a&&r>8)return this.fastDownsample(e,t,n);const o=new Array(t);if(r>=1)for(let s=0;s<t;s++){const t=Math.floor(s*r),a=Math.min(Math.ceil((s+1)*r),i),l=a-t,h=new Uint8Array(n);if(1===l)h.set(e[t]);else for(let s=0;s<n;s++){let i=0;for(let n=t;n<a;n++)i+=e[n][s];h[s]=Math.round(i/l)}o[s]=h}else for(let s=0;s<t;s++){const t=s*r,l=Math.floor(t),h=Math.min(l+1,i-1),c=t-l,u=new Uint8Array(n);if(0===c||l===h||a)u.set(e[l]);else{const t=e[l],s=e[h],i=1-c;for(let e=0;e<n;e++)u[e]=Math.round(t[e]*i+s[e]*c)}o[s]=u}return o}fastDownsample(e,t,s){const i=e.length/t,n=new Array(t);for(let r=0;r<t;r++){const t=Math.floor(r*i),a=Math.min(Math.floor((r+1)*i),e.length),o=Math.min(4,a-t),l=new Uint8Array(s);if(1===o)l.set(e[t]);else for(let i=0;i<s;i++){let s=0;for(let n=t;n<t+o;n++)s+=e[n][i];l[i]=Math.round(s/o)}n[r]=l}return n}fillImageDataQuality(e,t,s,i){const n=this.colorMap;for(let r=0;r<s;r++){const a=t[r];for(let t=0;t<i;t++){const o=n[a[t]],l=4*((i-t-1)*s+r);e[l]=255*o[0],e[l+1]=255*o[1],e[l+2]=255*o[2],e[l+3]=255*o[3]}}}fillImageDataFast(e,t,s,i){const n=this.colorMap,r=Math.max(1,Math.floor(i/256));for(let a=0;a<s;a++){const o=t[a];for(let t=0;t<i;t+=r){const l=n[o[t]];for(let n=0;n<r&&t+n<i;n++){const r=4*((i-t-n-1)*s+a);e[r]=255*l[0],e[r+1]=255*l[1],e[r+2]=255*l[2],e[r+3]=255*l[3]}}}}resample(e){return this.resampleChannel(e,this.getWidth())}}return N.MAX_CANVAS_WIDTH=3e4,N.MAX_NODES=10,N}));
